<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­ç»ƒä¹ æ—¥è®° | Daily English Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --bg-hover: #262c36;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-green: #3fb950;
            --accent-green-dim: rgba(63, 185, 80, 0.15);
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --accent-orange: #f0883e;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-cyan: #39c5cf;
            --accent-pink: #db61a2;
            --border-color: #30363d;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at 20% 20%, rgba(63, 185, 80, 0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(88, 166, 255, 0.06) 0%, transparent 50%); pointer-events: none; z-index: -1; }
        .container { max-width: 1400px; margin: 0 auto; padding: 32px 20px; }
        header { text-align: center; margin-bottom: 28px; }
        header h1 { font-family: 'Crimson Pro', serif; font-size: 2.8rem; font-weight: 600; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-green) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 6px; }
        header p { color: var(--text-secondary); font-size: 1rem; font-weight: 300; }
        .nav-tabs { display: flex; justify-content: center; gap: 6px; margin-bottom: 28px; flex-wrap: wrap; }
        .nav-tab { padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .nav-tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-tab.active { background: var(--accent-green); color: var(--bg-primary); border-color: var(--accent-green); font-weight: 500; }
        .nav-tab .badge { background: rgba(0,0,0,0.2); padding: 2px 7px; border-radius: 8px; font-size: 0.75rem; }
        .page { display: none; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 28px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent-green); }
        .stat-card .label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 3px; }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .stat-card.streak .value { color: var(--accent-orange); }
        .stat-card.total .value { color: var(--accent-green); }
        .stat-card.words .value { color: var(--accent-blue); }
        .stat-card.expressions .value { color: var(--accent-cyan); }
        .stat-card.mastered .value { color: var(--accent-yellow); }
        .main-content { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        .calendar-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 14px; padding: 18px; height: fit-content; position: sticky; top: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-title { font-size: 1.05rem; font-weight: 500; }
        .calendar-nav { display: flex; gap: 5px; }
        .calendar-nav button { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); width: 30px; height: 30px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; }
        .calendar-nav button:hover { background: var(--bg-hover); border-color: var(--accent-green); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 0.65rem; color: var(--text-muted); padding: 5px 0; font-weight: 500; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease; position: relative; border: 2px solid transparent; }
        .day:hover:not(.empty) { background: var(--bg-hover); }
        .day.today { border-color: var(--accent-blue); font-weight: 600; }
        .day.selected { background: var(--accent-green); color: var(--bg-primary); font-weight: 600; }
        .day.has-record::after { content: ''; position: absolute; bottom: 2px; width: 4px; height: 4px; background: var(--accent-green); border-radius: 50%; }
        .day.selected.has-record::after { background: var(--bg-primary); }
        .day.other-month { color: var(--text-muted); opacity: 0.5; }
        .record-section { display: flex; flex-direction: column; gap: 18px; }
        .record-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; }
        .record-card h3 { font-size: 0.95rem; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .record-card h3 .icon { font-size: 1.05rem; }
        .record-card h3 .auto-badge { font-size: 0.6rem; background: var(--accent-cyan); color: var(--bg-primary); padding: 2px 6px; border-radius: 6px; font-weight: 500; }
        .conversation-input { width: 100%; min-height: 130px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; color: var(--text-primary); font-family: inherit; font-size: 0.88rem; resize: vertical; transition: border-color 0.2s ease; line-height: 1.7; }
        .conversation-input:focus { outline: none; border-color: var(--accent-green); }
        .conversation-input::placeholder { color: var(--text-muted); }
        .extract-section { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .extract-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; font-size: 0.78rem; display: flex; align-items: center; gap: 5px; }
        .extract-btn:hover { border-color: var(--accent-cyan); background: rgba(57, 197, 207, 0.1); }
        .extract-btn.extracting { opacity: 0.7; pointer-events: none; }
        
        /* æ–°ç‰ˆç”Ÿè¯å¡ç‰‡æ ·å¼ */
        .word-cards { display: flex; flex-direction: column; gap: 12px; }
        .word-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px; transition: all 0.2s ease; animation: slideIn 0.3s ease-out; }
        .word-card:hover { border-color: var(--accent-blue); }
        .word-card.loading { opacity: 0.7; }
        .word-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .word-card-main { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
        .word-card-word { font-family: 'Crimson Pro', serif; font-size: 1.25rem; color: var(--accent-blue); cursor: pointer; transition: color 0.2s; }
        .word-card-word:hover { color: var(--accent-cyan); }
        .word-card-phonetic { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent-purple); }
        .word-card-actions { display: flex; gap: 6px; }
        .word-card-actions button { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; border-radius: 4px; font-size: 0.9rem; transition: all 0.2s; }
        .word-card-actions button:hover { color: var(--accent-red); background: rgba(248, 81, 73, 0.1); }
        .word-card-actions button.refresh:hover { color: var(--accent-cyan); background: rgba(57, 197, 207, 0.1); }
        .word-card-meaning { font-size: 0.9rem; color: var(--text-primary); margin-bottom: 10px; padding: 8px 10px; background: rgba(88, 166, 255, 0.08); border-radius: 6px; border-left: 3px solid var(--accent-blue); }
        .word-card-example { font-size: 0.85rem; padding: 10px 12px; background: rgba(163, 113, 247, 0.08); border-radius: 6px; border-left: 3px solid var(--accent-purple); cursor: pointer; transition: all 0.2s; }
        .word-card-example:hover { background: rgba(163, 113, 247, 0.12); }
        .word-card-example.speaking { border-left-color: var(--accent-cyan); background: rgba(57, 197, 207, 0.1); }
        .word-card-example .en { font-family: 'Crimson Pro', serif; font-size: 0.95rem; color: var(--text-primary); font-style: italic; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .word-card-example .en .speak-icon { font-size: 0.8rem; opacity: 0.5; }
        .word-card-example .zh { color: var(--text-secondary); font-size: 0.82rem; }
        .word-card-input { display: flex; flex-direction: column; gap: 8px; }
        .word-card-input input, .word-card-input textarea { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 10px; color: var(--text-primary); font-family: inherit; font-size: 0.85rem; transition: border-color 0.2s; }
        .word-card-input input:focus, .word-card-input textarea:focus { outline: none; border-color: var(--accent-blue); }
        .word-card-input .row { display: flex; gap: 8px; }
        .word-card-input .row input:first-child { flex: 1; font-family: 'Crimson Pro', serif; font-size: 1rem; }
        .word-card-input .row input:last-child { width: 120px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .word-card-input textarea { min-height: 50px; resize: vertical; }
        .word-card-status { font-size: 0.75rem; color: var(--accent-cyan); display: flex; align-items: center; gap: 5px; margin-top: 6px; }
        .word-card-status.error { color: var(--accent-red); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        
        .add-btn { display: flex; align-items: center; justify-content: center; gap: 5px; background: transparent; border: 2px dashed var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-size: 0.8rem; margin-top: 8px; }
        .add-btn:hover { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-dim); }
        
        .expression-card { background: linear-gradient(135deg, rgba(57, 197, 207, 0.08) 0%, rgba(163, 113, 247, 0.08) 100%); border: 1px solid rgba(57, 197, 207, 0.25); }
        .expression-list { display: flex; flex-direction: column; gap: 8px; }
        .vocab-item { display: flex; gap: 8px; align-items: flex-start; }
        .sentence-input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .sentence-input-group input { width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 9px 11px; color: var(--text-primary); font-family: inherit; font-size: 0.85rem; transition: border-color 0.2s ease; }
        .sentence-input-group input:focus { outline: none; border-color: var(--accent-purple); }
        .sentence-input-group input.en { font-family: 'Crimson Pro', serif; font-size: 0.95rem; }
        .vocab-item .delete-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 6px; border-radius: 6px; transition: all 0.2s ease; font-size: 0.95rem; }
        .vocab-item .delete-btn:hover { color: var(--accent-red); background: rgba(248, 81, 73, 0.1); }
        
        .expression-item { background: var(--bg-secondary); border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .expression-item:hover { background: var(--bg-hover); transform: translateX(3px); }
        .expression-item.speaking { border-left: 3px solid var(--accent-cyan); }
        .expression-item .en { font-family: 'Crimson Pro', serif; font-size: 0.95rem; color: var(--accent-cyan); margin-bottom: 3px; }
        .expression-item .zh { font-size: 0.82rem; color: var(--text-secondary); }
        
        .save-section { display: flex; gap: 10px; justify-content: flex-end; margin-top: 6px; }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--accent-green); border: none; color: var(--bg-primary); }
        .btn-primary:hover { background: #4ac95f; transform: translateY(-1px); }
        .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-hover); }
        
        /* ç”Ÿè¯åº“è¡¨æ ¼ - æ–°ç‰ˆ */
        .vocab-page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; flex-wrap: wrap; gap: 12px; }
        .vocab-page-header h2 { font-size: 1.2rem; font-weight: 500; }
        .vocab-controls { display: flex; gap: 8px; flex-wrap: wrap; }
        .search-box { position: relative; }
        .search-box input { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 9px 11px 9px 34px; color: var(--text-primary); font-size: 0.85rem; width: 180px; }
        .search-box input:focus { outline: none; border-color: var(--accent-blue); }
        .search-box::before { content: 'ğŸ”'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; }
        .filter-select { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 9px 11px; color: var(--text-primary); font-size: 0.85rem; cursor: pointer; }
        
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 14px; }
        .vocab-grid-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; transition: all 0.2s ease; cursor: pointer; }
        .vocab-grid-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(88, 166, 255, 0.1); }
        .vocab-grid-card.speaking { border-color: var(--accent-cyan); }
        .vocab-grid-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .vocab-grid-word { font-family: 'Crimson Pro', serif; font-size: 1.3rem; color: var(--accent-blue); }
        .vocab-grid-phonetic { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent-purple); margin-left: 8px; }
        .vocab-grid-meta { display: flex; gap: 6px; align-items: center; }
        .vocab-grid-meaning { font-size: 0.9rem; color: var(--text-primary); margin-bottom: 10px; }
        .vocab-grid-example { font-size: 0.82rem; color: var(--text-secondary); padding: 8px 10px; background: var(--bg-secondary); border-radius: 6px; border-left: 2px solid var(--accent-purple); }
        .vocab-grid-example .en { font-family: 'Crimson Pro', serif; font-style: italic; margin-bottom: 3px; color: var(--text-primary); }
        .vocab-grid-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); }
        
        .mastery-badge { display: inline-flex; align-items: center; gap: 3px; padding: 3px 7px; border-radius: 6px; font-size: 0.68rem; font-weight: 500; }
        .mastery-badge.new { background: rgba(88, 166, 255, 0.15); color: var(--accent-blue); }
        .mastery-badge.learning { background: rgba(240, 136, 62, 0.15); color: var(--accent-orange); }
        .mastery-badge.familiar { background: rgba(163, 113, 247, 0.15); color: var(--accent-purple); }
        .mastery-badge.mastered { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; }
        .pagination button { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .pagination button:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--accent-green); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination .page-info { color: var(--text-muted); font-size: 0.8rem; }
        
        .expression-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
        .expression-card-item { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s ease; }
        .expression-card-item:hover { border-color: var(--accent-cyan); transform: translateY(-2px); }
        .expression-card-item.speaking { border-color: var(--accent-cyan); box-shadow: 0 0 12px rgba(57, 197, 207, 0.15); }
        .expression-card-item .en { font-family: 'Crimson Pro', serif; font-size: 1.05rem; color: var(--text-primary); margin-bottom: 6px; line-height: 1.5; }
        .expression-card-item .zh { font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 8px; }
        .expression-card-item .meta { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--text-muted); }
        .expression-card-item .play-hint { color: var(--accent-cyan); }
        
        /* è®°å¿†æ¨¡å¼ */
        .memory-mode-container { max-width: 650px; margin: 0 auto; }
        .memory-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px; }
        .memory-stat { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; text-align: center; }
        .memory-stat .num { font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .memory-stat .label { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        .memory-stat.new .num { color: var(--accent-blue); }
        .memory-stat.learning .num { color: var(--accent-orange); }
        .memory-stat.familiar .num { color: var(--accent-purple); }
        .memory-stat.mastered .num { color: var(--accent-green); }
        
        .flashcard-container { perspective: 1000px; margin-bottom: 24px; }
        .flashcard { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; min-height: 320px; padding: 36px; cursor: pointer; transition: transform 0.6s, box-shadow 0.3s; transform-style: preserve-3d; position: relative; }
        .flashcard:hover { box-shadow: 0 8px 28px rgba(0, 0, 0, 0.3); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; backface-visibility: hidden; padding: 36px; left: 0; top: 0; }
        .flashcard-back { transform: rotateY(180deg); }
        .flashcard-word { font-family: 'Crimson Pro', serif; font-size: 2.8rem; color: var(--accent-blue); margin-bottom: 8px; text-align: center; cursor: pointer; }
        .flashcard-word:hover { color: var(--accent-cyan); }
        .flashcard-phonetic { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--accent-purple); margin-bottom: 12px; }
        .flashcard-hint { font-size: 0.85rem; color: var(--text-muted); }
        .flashcard-meaning { font-size: 1.3rem; color: var(--text-primary); text-align: center; margin-bottom: 16px; }
        .flashcard-example { font-size: 0.95rem; text-align: center; max-width: 90%; }
        .flashcard-example .en { font-family: 'Crimson Pro', serif; font-style: italic; color: var(--text-primary); margin-bottom: 4px; }
        .flashcard-example .zh { color: var(--text-secondary); font-size: 0.88rem; }
        .flashcard-progress { position: absolute; top: 14px; right: 18px; font-size: 0.8rem; color: var(--text-muted); }
        .flashcard-mastery { position: absolute; top: 14px; left: 18px; }
        .flashcard-speak { position: absolute; bottom: 14px; right: 18px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 10px; color: var(--text-secondary); cursor: pointer; font-size: 0.78rem; }
        .flashcard-speak:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        
        .memory-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .memory-btn { padding: 12px; border-radius: 10px; border: none; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .memory-btn:hover { transform: translateY(-2px); }
        .memory-btn .label { font-size: 0.85rem; font-weight: 500; }
        .memory-btn .desc { font-size: 0.65rem; opacity: 0.8; }
        .memory-btn.again { background: var(--accent-red); color: white; }
        .memory-btn.hard { background: var(--accent-orange); color: white; }
        .memory-btn.good { background: var(--accent-blue); color: white; }
        .memory-btn.easy { background: var(--accent-green); color: var(--bg-primary); }
        
        .start-review { text-align: center; padding: 50px 20px; }
        .start-review h2 { font-size: 1.4rem; margin-bottom: 12px; }
        .start-review p { color: var(--text-secondary); margin-bottom: 24px; }
        .review-options { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .review-option { background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 16px 22px; cursor: pointer; transition: all 0.2s ease; text-align: center; min-width: 110px; }
        .review-option:hover { border-color: var(--accent-green); transform: translateY(-2px); }
        .review-option .num { font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-green); }
        .review-option .label { font-size: 0.78rem; color: var(--text-secondary); margin-top: 4px; }
        
        .review-complete { text-align: center; padding: 50px 20px; }
        .review-complete .icon { font-size: 3rem; margin-bottom: 16px; }
        .review-complete h2 { font-size: 1.4rem; margin-bottom: 12px; color: var(--accent-green); }
        .review-complete p { color: var(--text-secondary); margin-bottom: 20px; }
        .review-summary { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .review-summary-item { text-align: center; }
        .review-summary-item .num { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .review-summary-item .label { font-size: 0.72rem; color: var(--text-muted); }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state .icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
        .empty-state p { font-size: 0.88rem; }
        
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-card); border: 1px solid var(--accent-green); border-radius: 10px; padding: 12px 18px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 8px; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast .icon { color: var(--accent-green); font-size: 1rem; }
        
        .speech-control { position: fixed; bottom: 24px; left: 24px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 14px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); z-index: 100; }
        .speech-control label { font-size: 0.78rem; color: var(--text-secondary); }
        .speech-control input[type="range"] { width: 80px; accent-color: var(--accent-cyan); }
        .speech-control .speed-value { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; color: var(--accent-cyan); min-width: 32px; }
        
        @media (max-width: 768px) {
            .container { padding: 16px 12px; }
            header h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .calendar-section { position: static; }
            .record-card { padding: 14px; }
            .word-card-input .row { flex-direction: column; }
            .word-card-input .row input:last-child { width: 100%; }
            .vocab-grid { grid-template-columns: 1fr; }
            .memory-stats { grid-template-columns: repeat(2, 1fr); }
            .memory-buttons { grid-template-columns: repeat(2, 1fr); }
            .flashcard-word { font-size: 2rem; }
            .expression-grid { grid-template-columns: 1fr; }
            .speech-control { left: 12px; bottom: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Daily English Journal</h1>
            <p>æ¯å¤©30åˆ†é’Ÿï¼Œè®°å½•ä¸AIçš„è‹±è¯­å¯¹è¯</p>
        </header>
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchPage('journal')">ğŸ“… æ¯æ—¥è®°å½•</div>
            <div class="nav-tab" onclick="switchPage('vocabulary')">ğŸ“š ç”Ÿè¯åº“ <span class="badge" id="vocabCount">0</span></div>
            <div class="nav-tab" onclick="switchPage('expressions')">ğŸ’¬ ä»Šæ—¥è¡¨è¾¾ <span class="badge" id="exprCount">0</span></div>
            <div class="nav-tab" onclick="switchPage('memory')">ğŸ§  è®°å¿†æ¨¡å¼</div>
        </div>
        <div class="page active" id="journalPage">
            <div class="stats-grid">
                <div class="stat-card streak"><div class="label">ğŸ”¥ è¿ç»­æ‰“å¡</div><div class="value" id="streakDays">0</div></div>
                <div class="stat-card total"><div class="label">ğŸ“… ç´¯è®¡å¤©æ•°</div><div class="value" id="totalDays">0</div></div>
                <div class="stat-card words"><div class="label">ğŸ“š ç”Ÿè¯æ•°é‡</div><div class="value" id="totalWords">0</div></div>
                <div class="stat-card expressions"><div class="label">ğŸ’¬ ä»Šæ—¥è¡¨è¾¾</div><div class="value" id="totalExpressions">0</div></div>
                <div class="stat-card mastered"><div class="label">ğŸ† å·²æŒæ¡</div><div class="value" id="masteredWords">0</div></div>
            </div>
            <div class="main-content">
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-title" id="calendarTitle">2024å¹´1æœˆ</div>
                        <div class="calendar-nav"><button onclick="prevMonth()">â€¹</button><button onclick="nextMonth()">â€º</button></div>
                    </div>
                    <div class="calendar-weekdays"><div class="weekday">æ—¥</div><div class="weekday">ä¸€</div><div class="weekday">äºŒ</div><div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div></div>
                    <div class="calendar-days" id="calendarDays"></div>
                </div>
                <div class="record-section">
                    <div class="record-card">
                        <h3><span class="icon">ğŸ’¬</span> ä»Šæ—¥å¯¹è¯å†…å®¹ <span class="auto-badge">æ™ºèƒ½æå–</span></h3>
                        <textarea class="conversation-input" id="conversationInput" placeholder="ç²˜è´´ä»Šå¤©å’ŒChatGPTçš„å¯¹è¯å†…å®¹...&#10;&#10;ç‚¹å‡»ã€Œæå–ç”Ÿè¯ã€è‡ªåŠ¨è·å–ï¼š&#10;â€¢ å•è¯ã€éŸ³æ ‡ã€é‡Šä¹‰ã€ä¾‹å¥"></textarea>
                        <div class="extract-section">
                            <button class="extract-btn" onclick="extractVocabulary()" id="extractVocabBtn"><span>ğŸ“–</span> æå–ç”Ÿè¯ï¼ˆè‡ªåŠ¨æŸ¥è¯å…¸ï¼‰</button>
                            <button class="extract-btn" onclick="extractExpressions()" id="extractExprBtn"><span>ğŸ’¡</span> æå–è¡¨è¾¾</button>
                        </div>
                    </div>
                    <div class="record-card">
                        <h3><span class="icon">ğŸ“–</span> ç”Ÿè¯è®°å½• <span class="auto-badge">å«éŸ³æ ‡+ä¾‹å¥</span></h3>
                        <div class="word-cards" id="wordCards"></div>
                        <button class="add-btn" onclick="addWordCard()"><span>+</span> æ‰‹åŠ¨æ·»åŠ ç”Ÿè¯</button>
                    </div>
                    <div class="record-card expression-card">
                        <h3><span class="icon">ğŸ’¬</span> ä»Šæ—¥è¡¨è¾¾ <span class="auto-badge">ç‚¹å‡»æœ—è¯»</span></h3>
                        <div class="expression-list" id="expressionsList">
                            <div class="vocab-item">
                                <div class="sentence-input-group">
                                    <input type="text" class="en" placeholder="English expression">
                                    <input type="text" class="zh" placeholder="ä¸­æ–‡ç¿»è¯‘">
                                </div>
                                <button class="delete-btn" onclick="deleteExpression(this)">Ã—</button>
                            </div>
                        </div>
                        <button class="add-btn" onclick="addExpression()"><span>+</span> æ·»åŠ è¡¨è¾¾</button>
                    </div>
                    <div class="save-section">
                        <button class="btn btn-secondary" onclick="clearForm()">æ¸…ç©º</button>
                        <button class="btn btn-primary" onclick="saveRecord()"><span>ğŸ’¾</span> ä¿å­˜</button>
                    </div>
                    <div id="historyPreview"></div>
                </div>
            </div>
        </div>
        <div class="page" id="vocabularyPage">
            <div class="vocab-page-header">
                <h2>ğŸ“š æˆ‘çš„ç”Ÿè¯åº“</h2>
                <div class="vocab-controls">
                    <div class="search-box"><input type="text" id="vocabSearch" placeholder="æœç´¢..." oninput="filterVocab()"></div>
                    <select class="filter-select" id="masteryFilter" onchange="filterVocab()">
                        <option value="all">å…¨éƒ¨</option><option value="new">ğŸ†• æ–°è¯</option><option value="learning">ğŸ“– å­¦ä¹ ä¸­</option><option value="familiar">ğŸ’¡ ç†Ÿæ‚‰</option><option value="mastered">âœ… å·²æŒæ¡</option>
                    </select>
                </div>
            </div>
            <div class="vocab-grid" id="vocabGrid"></div>
            <div class="pagination" id="vocabPagination"></div>
        </div>
        <div class="page" id="expressionsPage">
            <div class="vocab-page-header">
                <h2>ğŸ’¬ ä»Šæ—¥è¡¨è¾¾åº“ <span style="font-size:0.8rem;color:var(--text-muted);font-weight:400">ç‚¹å‡»æœ—è¯»</span></h2>
                <div class="vocab-controls"><div class="search-box"><input type="text" id="exprSearch" placeholder="æœç´¢..." oninput="filterExpressions()"></div></div>
            </div>
            <div class="expression-grid" id="expressionGrid"></div>
            <div class="pagination" id="exprPagination"></div>
        </div>
        <div class="page" id="memoryPage">
            <div class="memory-mode-container">
                <div class="memory-stats">
                    <div class="memory-stat new"><div class="num" id="memNewCount">0</div><div class="label">æ–°è¯</div></div>
                    <div class="memory-stat learning"><div class="num" id="memLearningCount">0</div><div class="label">å­¦ä¹ ä¸­</div></div>
                    <div class="memory-stat familiar"><div class="num" id="memFamiliarCount">0</div><div class="label">ç†Ÿæ‚‰</div></div>
                    <div class="memory-stat mastered"><div class="num" id="memMasteredCount">0</div><div class="label">å·²æŒæ¡</div></div>
                </div>
                <div id="memoryContent"></div>
            </div>
        </div>
    </div>
    <div class="speech-control">
        <label>ğŸ”Š è¯­é€Ÿ</label>
        <input type="range" id="speechRate" min="0.3" max="1" step="0.1" value="0.6" oninput="updateSpeechRate()">
        <span class="speed-value" id="speedValue">0.6x</span>
    </div>
    <div class="toast" id="toast"><span class="icon">âœ“</span><span id="toastMessage">æˆåŠŸ</span></div>

<script>
const STORAGE_KEY='english_journal_data',VOCAB_KEY='english_vocabulary_data',EXPR_KEY='english_expressions_data';
let currentYear=new Date().getFullYear(),currentMonth=new Date().getMonth(),selectedDate=new Date().toISOString().split('T')[0];
let currentVocabPage=1,currentExprPage=1,PER_PAGE=12,speechRate=0.6,currentSpeaking=null;
let reviewQueue=[],currentCardIndex=0,reviewStats={again:0,hard:0,good:0,easy:0},isCardFlipped=false;
let wordCardsData=[];
const commonWords=new Set(['the','a','an','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','shall','can','need','to','of','in','for','on','with','at','by','from','up','about','into','over','after','under','i','you','he','she','it','we','they','me','him','her','us','them','my','your','his','its','our','their','this','that','these','those','what','which','who','where','when','why','how','all','each','every','both','few','more','most','other','some','no','not','only','same','so','than','too','very','just','also','now','here','there','then','and','but','or','if','because','as','until','while','although','though','before','since','unless','however','therefore','like','get','got','make','made','go','went','come','came','take','took','see','saw','know','knew','think','thought','want','say','said','tell','told','use','used','find','found','give','gave','let','put','seem','leave','left','call','called','keep','kept','try','tried','ask','asked','work','worked','become','became','look','looked','show','showed','hear','heard','play','played','run','ran','move','moved','live','lived','believe','believed','hold','held','bring','brought','happen','happened','write','wrote','provide','provided','sit','sat','stand','stood','lose','lost','pay','paid','meet','met','include','included','continue','continued','set','learn','learned','change','changed','lead','led','understand','understood','watch','watched','follow','followed','stop','stopped','create','created','speak','spoke','read','allow','allowed','add','added','spend','spent','grow','grew','open','opened','walk','walked','win','won','offer','offered','remember','remembered','love','loved','consider','considered','appear','appeared','buy','bought','wait','waited','serve','served','die','died','send','sent','expect','expected','build','built','stay','stayed','fall','fell','cut','reach','reached','kill','killed','remain','remained','suggest','suggested','raise','raised','pass','passed','sell','sold','require','required','report','reported','decide','decided','pull','pulled']);

// è¯­éŸ³åŠŸèƒ½
function speak(text,onEnd){if('speechSynthesis'in window){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.lang='en-US';u.rate=speechRate;const v=window.speechSynthesis.getVoices(),ev=v.find(x=>x.lang.includes('en'));if(ev)u.voice=ev;u.onend=()=>{if(currentSpeaking){currentSpeaking.classList.remove('speaking');currentSpeaking=null}if(onEnd)onEnd()};window.speechSynthesis.speak(u)}}
function speakElement(el,text){if(currentSpeaking){currentSpeaking.classList.remove('speaking');window.speechSynthesis.cancel();if(currentSpeaking===el){currentSpeaking=null;return}}currentSpeaking=el;el.classList.add('speaking');speak(text)}
function updateSpeechRate(){speechRate=parseFloat(document.getElementById('speechRate').value);document.getElementById('speedValue').textContent=speechRate+'x'}
if('speechSynthesis'in window){window.speechSynthesis.getVoices();window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices()}

// æ•°æ®å­˜å‚¨
function getAllRecords(){return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}
function saveAllRecords(r){localStorage.setItem(STORAGE_KEY,JSON.stringify(r))}
function getVocabulary(){return JSON.parse(localStorage.getItem(VOCAB_KEY)||'{}')}
function saveVocabulary(v){localStorage.setItem(VOCAB_KEY,JSON.stringify(v))}
function getExpressions(){return JSON.parse(localStorage.getItem(EXPR_KEY)||'{}')}
function saveExpressions(e){localStorage.setItem(EXPR_KEY,JSON.stringify(e))}
function getRecord(d){return getAllRecords()[d]||null}

// è¯å…¸API - ä½¿ç”¨Free Dictionary API
async function lookupWord(word){
    try{
        const res=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word.toLowerCase())}`);
        if(!res.ok)return null;
        const data=await res.json();
        if(!data||!data[0])return null;
        const entry=data[0];
        let phonetic='';
        if(entry.phonetic)phonetic=entry.phonetic;
        else if(entry.phonetics&&entry.phonetics.length>0){
            const p=entry.phonetics.find(x=>x.text)||entry.phonetics[0];
            if(p.text)phonetic=p.text;
        }
        let meaning='';
        let example='';
        let exampleZh='';
        if(entry.meanings&&entry.meanings.length>0){
            const m=entry.meanings[0];
            const partOfSpeech=m.partOfSpeech||'';
            if(m.definitions&&m.definitions.length>0){
                const def=m.definitions[0];
                meaning=(partOfSpeech?`[${partOfSpeech}] `:'')+def.definition;
                if(def.example)example=def.example;
            }
        }
        return{word:entry.word||word,phonetic,meaning,example,exampleZh};
    }catch(e){console.error('Dictionary lookup failed:',e);return null}
}

// æå–ç”Ÿè¯
async function extractVocabulary(){
    const btn=document.getElementById('extractVocabBtn');
    btn.classList.add('extracting');
    btn.innerHTML='<span>â³</span> æå–å¹¶æŸ¥è¯¢è¯å…¸...';
    const text=document.getElementById('conversationInput').value;
    const words=extractWordsFromText(text);
    if(words.length===0){
        showToast('æœªæ‰¾åˆ°ç”Ÿè¯');
        btn.classList.remove('extracting');
        btn.innerHTML='<span>ğŸ“–</span> æå–ç”Ÿè¯ï¼ˆè‡ªåŠ¨æŸ¥è¯å…¸ï¼‰';
        return;
    }
    wordCardsData=[];
    for(let i=0;i<Math.min(words.length,10);i++){
        const w=words[i];
        wordCardsData.push({id:Date.now()+i,word:w.word,phonetic:'',meaning:w.meaning||'',example:'',exampleZh:'',loading:true});
    }
    renderWordCards();
    for(let i=0;i<wordCardsData.length;i++){
        const card=wordCardsData[i];
        const dictData=await lookupWord(card.word);
        if(dictData){
            card.phonetic=dictData.phonetic||'';
            if(!card.meaning&&dictData.meaning)card.meaning=dictData.meaning;
            card.example=dictData.example||'';
            card.exampleZh=dictData.exampleZh||'';
        }
        card.loading=false;
        renderWordCards();
        await new Promise(r=>setTimeout(r,300));
    }
    showToast(`æå– ${wordCardsData.length} ä¸ªç”Ÿè¯`);
    btn.classList.remove('extracting');
    btn.innerHTML='<span>ğŸ“–</span> æå–ç”Ÿè¯ï¼ˆè‡ªåŠ¨æŸ¥è¯å…¸ï¼‰';
}

function extractWordsFromText(text){
    const words=[],seen=new Set();
    const p1=/["']?([a-zA-Z][a-zA-Z-]{2,20})["']?\s*[-â€“â€”:ï¼š]\s*([^\n]+)/g;
    let m;
    while((m=p1.exec(text))!==null){
        const w=m[1].trim().toLowerCase(),mg=m[2].trim();
        if(w.length>2&&!commonWords.has(w)&&!seen.has(w)){seen.add(w);words.push({word:m[1].trim(),meaning:mg})}
    }
    const p2=/\b([a-zA-Z]{5,15})\b/g;
    while((m=p2.exec(text))!==null){
        const w=m[1].toLowerCase();
        if(!commonWords.has(w)&&!seen.has(w)&&!/^[A-Z]/.test(m[1])){seen.add(w);words.push({word:m[1],meaning:''})}
    }
    return words.slice(0,10);
}

// æ¸²æŸ“ç”Ÿè¯å¡ç‰‡
function renderWordCards(){
    const container=document.getElementById('wordCards');
    if(wordCardsData.length===0){
        container.innerHTML='<div class="empty-state" style="padding:20px"><p style="font-size:0.85rem;color:var(--text-muted)">ç‚¹å‡»ã€Œæå–ç”Ÿè¯ã€æˆ–ã€Œæ‰‹åŠ¨æ·»åŠ ã€</p></div>';
        return;
    }
    container.innerHTML=wordCardsData.map((card,idx)=>`
        <div class="word-card ${card.loading?'loading':''}" data-idx="${idx}">
            <div class="word-card-header">
                <div class="word-card-main">
                    <span class="word-card-word" onclick="speak('${escapeHtml(card.word)}')">${escapeHtml(card.word)}</span>
                    <span class="word-card-phonetic">${escapeHtml(card.phonetic)}</span>
                </div>
                <div class="word-card-actions">
                    <button class="refresh" onclick="refreshWordCard(${idx})" title="é‡æ–°æŸ¥è¯¢">ğŸ”„</button>
                    <button onclick="deleteWordCard(${idx})" title="åˆ é™¤">Ã—</button>
                </div>
            </div>
            <div class="word-card-input">
                <div class="row">
                    <input type="text" value="${escapeHtml(card.word)}" onchange="updateWordCard(${idx},'word',this.value)" placeholder="å•è¯">
                    <input type="text" value="${escapeHtml(card.phonetic)}" onchange="updateWordCard(${idx},'phonetic',this.value)" placeholder="éŸ³æ ‡">
                </div>
                <input type="text" value="${escapeHtml(card.meaning)}" onchange="updateWordCard(${idx},'meaning',this.value)" placeholder="ä¸­æ–‡é‡Šä¹‰">
                <textarea onchange="updateWordCard(${idx},'example',this.value)" placeholder="ä¾‹å¥ï¼ˆè‹±æ–‡ï¼‰">${escapeHtml(card.example)}</textarea>
                <input type="text" value="${escapeHtml(card.exampleZh)}" onchange="updateWordCard(${idx},'exampleZh',this.value)" placeholder="ä¾‹å¥ç¿»è¯‘ï¼ˆä¸­æ–‡ï¼‰">
            </div>
            ${card.loading?'<div class="word-card-status">â³ æ­£åœ¨æŸ¥è¯¢è¯å…¸...</div>':''}
        </div>
    `).join('');
}

function updateWordCard(idx,field,value){wordCardsData[idx][field]=value}
function deleteWordCard(idx){wordCardsData.splice(idx,1);renderWordCards()}
async function refreshWordCard(idx){
    const card=wordCardsData[idx];
    card.loading=true;
    renderWordCards();
    const dictData=await lookupWord(card.word);
    if(dictData){
        card.phonetic=dictData.phonetic||card.phonetic;
        card.meaning=dictData.meaning||card.meaning;
        card.example=dictData.example||card.example;
    }
    card.loading=false;
    renderWordCards();
    showToast('å·²æ›´æ–°');
}

function addWordCard(){
    wordCardsData.push({id:Date.now(),word:'',phonetic:'',meaning:'',example:'',exampleZh:'',loading:false});
    renderWordCards();
}

// æå–è¡¨è¾¾
function extractExpressions(){
    const btn=document.getElementById('extractExprBtn');
    btn.classList.add('extracting');
    btn.innerHTML='<span>â³</span> æå–ä¸­...';
    const text=document.getElementById('conversationInput').value;
    setTimeout(()=>{
        const expr=extractExpressionsFromText(text);
        if(expr.length>0){
            const list=document.getElementById('expressionsList');
            const items=list.querySelectorAll('.vocab-item');
            const first=items[0];
            if(first&&!first.querySelector('.en').value&&!first.querySelector('.zh').value&&items.length===1)list.innerHTML='';
            expr.forEach(e=>{
                const item=document.createElement('div');
                item.className='vocab-item';
                item.innerHTML=`<div class="sentence-input-group"><input type="text" class="en" value="${escapeHtml(e.en)}"><input type="text" class="zh" value="${escapeHtml(e.zh||'')}"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button>`;
                list.appendChild(item);
            });
            showToast(`æå– ${expr.length} ä¸ªè¡¨è¾¾`);
        }else{showToast('æœªæ‰¾åˆ°è¡¨è¾¾')}
        btn.classList.remove('extracting');
        btn.innerHTML='<span>ğŸ’¡</span> æå–è¡¨è¾¾';
    },400);
}

function extractExpressionsFromText(text){
    const expr=[],seen=new Set();
    const sentences=text.split(/[.!?ã€‚ï¼ï¼Ÿ]+/).filter(s=>s.trim().length>10);
    sentences.forEach(s=>{
        const t=s.trim();
        if(/^[A-Z][a-zA-Z\s,'"'-]+/.test(t)&&t.length>15&&t.length<120){
            const l=t.toLowerCase();
            if(!seen.has(l)){seen.add(l);expr.push({en:t,zh:''})}
        }
    });
    return expr.slice(0,12);
}

function switchPage(page){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(page+'Page').classList.add('active');
    event.target.closest('.nav-tab').classList.add('active');
    if(page==='vocabulary')renderVocabGrid();
    else if(page==='expressions')renderExpressionsGrid();
    else if(page==='memory')renderMemoryPage();
}

function saveRecord(){
    const conv=document.getElementById('conversationInput').value.trim();
    const words=wordCardsData.filter(w=>w.word).map(w=>({word:w.word,phonetic:w.phonetic,meaning:w.meaning,example:w.example,exampleZh:w.exampleZh}));
    const expr=[];
    document.querySelectorAll('#expressionsList .vocab-item').forEach(item=>{
        const en=item.querySelector('.en').value.trim(),zh=item.querySelector('.zh').value.trim();
        if(en)expr.push({en,zh});
    });
    if(!conv&&words.length===0&&expr.length===0){showToast('è¯·å¡«å†™å†…å®¹');return}
    const records=getAllRecords();
    records[selectedDate]={conversation:conv,words,expressions:expr,updatedAt:new Date().toISOString()};
    saveAllRecords(records);
    syncVocabulary();
    syncExpressions();
    updateStats();
    renderCalendar();
    showHistoryPreview();
    showToast('ä¿å­˜æˆåŠŸ ğŸ’ª');
}

function syncVocabulary(){
    const records=getAllRecords(),vocab=getVocabulary();
    Object.keys(records).forEach(date=>{
        const r=records[date];
        if(r.words){r.words.forEach(w=>{
            const k=w.word.toLowerCase();
            if(w.word&&!vocab[k]){
                vocab[k]={word:w.word,phonetic:w.phonetic||'',meaning:w.meaning||'',example:w.example||'',exampleZh:w.exampleZh||'',addedDate:date,mastery:'new',reviewCount:0,lastReview:null,nextReview:date};
            }else if(w.word&&vocab[k]){
                if(w.phonetic&&!vocab[k].phonetic)vocab[k].phonetic=w.phonetic;
                if(w.meaning&&!vocab[k].meaning)vocab[k].meaning=w.meaning;
                if(w.example&&!vocab[k].example)vocab[k].example=w.example;
                if(w.exampleZh&&!vocab[k].exampleZh)vocab[k].exampleZh=w.exampleZh;
            }
        })}
    });
    saveVocabulary(vocab);updateVocabCount();
}

function syncExpressions(){
    const records=getAllRecords(),expr=getExpressions();
    Object.keys(records).forEach(date=>{
        const r=records[date];
        if(r.expressions){r.expressions.forEach(e=>{
            const k=e.en.toLowerCase().substring(0,50);
            if(e.en&&!expr[k]){expr[k]={en:e.en,zh:e.zh,addedDate:date}}
        })}
    });
    saveExpressions(expr);updateExprCount();
}

function clearForm(){
    document.getElementById('conversationInput').value='';
    wordCardsData=[];
    renderWordCards();
    document.getElementById('expressionsList').innerHTML='<div class="vocab-item"><div class="sentence-input-group"><input type="text" class="en" placeholder="English expression"><input type="text" class="zh" placeholder="ä¸­æ–‡ç¿»è¯‘"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button></div>';
}

function loadRecord(date){
    const r=getRecord(date);
    clearForm();
    if(r){
        document.getElementById('conversationInput').value=r.conversation||'';
        if(r.words&&r.words.length>0){
            wordCardsData=r.words.map((w,i)=>({id:Date.now()+i,word:w.word||'',phonetic:w.phonetic||'',meaning:w.meaning||'',example:w.example||'',exampleZh:w.exampleZh||'',loading:false}));
            renderWordCards();
        }
        if(r.expressions&&r.expressions.length>0){
            document.getElementById('expressionsList').innerHTML=r.expressions.map(e=>`<div class="vocab-item"><div class="sentence-input-group"><input type="text" class="en" value="${escapeHtml(e.en)}"><input type="text" class="zh" value="${escapeHtml(e.zh)}"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button></div>`).join('');
        }
    }
    showHistoryPreview();
}

function escapeHtml(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML}
function addExpression(){const l=document.getElementById('expressionsList'),i=document.createElement('div');i.className='vocab-item';i.innerHTML='<div class="sentence-input-group"><input type="text" class="en" placeholder="English expression"><input type="text" class="zh" placeholder="ä¸­æ–‡ç¿»è¯‘"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button>';l.appendChild(i);i.querySelector('.en').focus()}
function deleteExpression(btn){const l=document.getElementById('expressionsList');if(l.children.length>1)btn.parentElement.remove();else btn.parentElement.querySelectorAll('input').forEach(i=>i.value='')}

function renderCalendar(){
    const records=getAllRecords();
    const fd=new Date(currentYear,currentMonth,1),ld=new Date(currentYear,currentMonth+1,0);
    const sd=fd.getDay(),dm=ld.getDate();
    document.getElementById('calendarTitle').textContent=`${currentYear}å¹´${currentMonth+1}æœˆ`;
    const today=new Date().toISOString().split('T')[0];
    let h='';
    const pld=new Date(currentYear,currentMonth,0).getDate();
    for(let i=sd-1;i>=0;i--){const d=pld-i;const pm=currentMonth===0?11:currentMonth-1;const py=currentMonth===0?currentYear-1:currentYear;const ds=`${py}-${String(pm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const hr=records[ds]?'has-record':'';h+=`<div class="day other-month ${hr}" data-date="${ds}">${d}</div>`}
    for(let d=1;d<=dm;d++){const ds=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const it=ds===today?'today':'';const is=ds===selectedDate?'selected':'';const hr=records[ds]?'has-record':'';h+=`<div class="day ${it} ${is} ${hr}" data-date="${ds}">${d}</div>`}
    const rd=42-(sd+dm);
    for(let d=1;d<=rd;d++){const nm=currentMonth===11?0:currentMonth+1;const ny=currentMonth===11?currentYear+1:currentYear;const ds=`${ny}-${String(nm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const hr=records[ds]?'has-record':'';h+=`<div class="day other-month ${hr}" data-date="${ds}">${d}</div>`}
    document.getElementById('calendarDays').innerHTML=h;
    document.querySelectorAll('.day:not(.empty)').forEach(de=>de.addEventListener('click',()=>selectDate(de.dataset.date)));
}
function selectDate(d){selectedDate=d;const o=new Date(d);currentYear=o.getFullYear();currentMonth=o.getMonth();renderCalendar();loadRecord(d)}
function prevMonth(){currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--}renderCalendar()}
function nextMonth(){currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++}renderCalendar()}

function updateStats(){
    const records=getAllRecords(),vocab=getVocabulary(),expr=getExpressions();
    const dates=Object.keys(records).sort();
    document.getElementById('totalDays').textContent=dates.length;
    document.getElementById('totalWords').textContent=Object.keys(vocab).length;
    document.getElementById('totalExpressions').textContent=Object.keys(expr).length;
    const mc=Object.values(vocab).filter(v=>v.mastery==='mastered').length;
    document.getElementById('masteredWords').textContent=mc;
    let streak=0;const today=new Date();today.setHours(0,0,0,0);
    for(let i=0;i<=365;i++){const cd=new Date(today);cd.setDate(cd.getDate()-i);const ds=cd.toISOString().split('T')[0];if(records[ds])streak++;else if(i>0)break}
    document.getElementById('streakDays').textContent=streak;
}
function updateVocabCount(){document.getElementById('vocabCount').textContent=Object.keys(getVocabulary()).length}
function updateExprCount(){document.getElementById('exprCount').textContent=Object.keys(getExpressions()).length}

function showHistoryPreview(){
    const r=getRecord(selectedDate);const c=document.getElementById('historyPreview');
    if(!r){c.innerHTML='<div class="empty-state"><div class="icon">ğŸ“</div><p>è¿™å¤©è¿˜æ²¡æœ‰è®°å½•</p></div>';return}
    const o=new Date(selectedDate);const ds=`${o.getFullYear()}å¹´${o.getMonth()+1}æœˆ${o.getDate()}æ—¥`;
    let h=`<div class="record-card" style="margin-top:18px"><h3><span class="icon">ğŸ“‹</span> ${ds}</h3>`;
    if(r.words&&r.words.length>0){
        h+='<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">';
        r.words.forEach(w=>{
            h+=`<div class="word-card" style="cursor:pointer" onclick="speak('${escapeHtml(w.word).replace(/'/g,"\\'")}')">
                <div class="word-card-header"><div class="word-card-main"><span class="word-card-word">${escapeHtml(w.word)}</span><span class="word-card-phonetic">${escapeHtml(w.phonetic||'')}</span></div></div>
                ${w.meaning?`<div class="word-card-meaning">${escapeHtml(w.meaning)}</div>`:''}
                ${w.example?`<div class="word-card-example" onclick="event.stopPropagation();speakElement(this,'${escapeHtml(w.example).replace(/'/g,"\\'")}')"><div class="en"><span class="speak-icon">ğŸ”Š</span> ${escapeHtml(w.example)}</div>${w.exampleZh?`<div class="zh">${escapeHtml(w.exampleZh)}</div>`:''}</div>`:''}
            </div>`;
        });
        h+='</div>';
    }
    if(r.expressions&&r.expressions.length>0){
        h+='<div class="expression-list">';
        r.expressions.forEach(e=>{h+=`<div class="expression-item" onclick="speakElement(this,'${escapeHtml(e.en).replace(/'/g,"\\'")}')"><div class="en">ğŸ”Š ${escapeHtml(e.en)}</div><div class="zh">${escapeHtml(e.zh)}</div></div>`});
        h+='</div>';
    }
    h+='</div>';c.innerHTML=h;
}

function renderVocabGrid(){
    const vocab=getVocabulary();const search=document.getElementById('vocabSearch').value.toLowerCase();const mf=document.getElementById('masteryFilter').value;
    let items=Object.values(vocab);
    if(search)items=items.filter(v=>v.word.toLowerCase().includes(search)||v.meaning.toLowerCase().includes(search));
    if(mf!=='all')items=items.filter(v=>v.mastery===mf);
    items.sort((a,b)=>new Date(b.addedDate)-new Date(a.addedDate));
    const tp=Math.ceil(items.length/PER_PAGE);const si=(currentVocabPage-1)*PER_PAGE;const pi=items.slice(si,si+PER_PAGE);
    const g=document.getElementById('vocabGrid');
    if(items.length===0){g.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ“š</div><p>è¿˜æ²¡æœ‰ç”Ÿè¯</p></div>'}
    else{g.innerHTML=pi.map(v=>`
        <div class="vocab-grid-card" onclick="speakElement(this,'${escapeHtml(v.word).replace(/'/g,"\\'")}')">
            <div class="vocab-grid-header">
                <div><span class="vocab-grid-word">${escapeHtml(v.word)}</span><span class="vocab-grid-phonetic">${escapeHtml(v.phonetic||'')}</span></div>
                <div class="vocab-grid-meta">${getMasteryBadge(v.mastery)}<button class="action-btn" onclick="event.stopPropagation();deleteVocab('${v.word.toLowerCase()}')" style="margin-left:4px">ğŸ—‘ï¸</button></div>
            </div>
            <div class="vocab-grid-meaning">${escapeHtml(v.meaning||'æš‚æ— é‡Šä¹‰')}</div>
            ${v.example?`<div class="vocab-grid-example" onclick="event.stopPropagation();speakElement(this,'${escapeHtml(v.example).replace(/'/g,"\\'")}')"><div class="en">ğŸ”Š ${escapeHtml(v.example)}</div>${v.exampleZh?`<div class="zh">${escapeHtml(v.exampleZh)}</div>`:''}</div>`:''}
            <div class="vocab-grid-footer"><span>${v.addedDate}</span><span style="color:var(--accent-cyan)">ğŸ”Š ç‚¹å‡»æœ—è¯»</span></div>
        </div>
    `).join('')}
    renderPagination('vocabPagination',tp,currentVocabPage,p=>{currentVocabPage=p;renderVocabGrid()});
}
function getMasteryBadge(m){const b={new:'<span class="mastery-badge new">ğŸ†• æ–°</span>',learning:'<span class="mastery-badge learning">ğŸ“– å­¦ä¹ </span>',familiar:'<span class="mastery-badge familiar">ğŸ’¡ ç†Ÿæ‚‰</span>',mastered:'<span class="mastery-badge mastered">âœ… æŒæ¡</span>'};return b[m]||b.new}
function renderPagination(cid,tp,cp,opc){const c=document.getElementById(cid);if(tp<=1){c.innerHTML='';return}c.innerHTML=`<button ${cp===1?'disabled':''}>ä¸Šä¸€é¡µ</button><span class="page-info">${cp}/${tp}</span><button ${cp===tp?'disabled':''}>ä¸‹ä¸€é¡µ</button>`;c.querySelector('button:first-child').onclick=()=>{if(cp>1)opc(cp-1)};c.querySelector('button:last-child').onclick=()=>{if(cp<tp)opc(cp+1)}}
function filterVocab(){currentVocabPage=1;renderVocabGrid()}
function deleteVocab(k){if(confirm('åˆ é™¤ï¼Ÿ')){const v=getVocabulary();delete v[k];saveVocabulary(v);renderVocabGrid();updateVocabCount();updateStats();showToast('å·²åˆ é™¤')}}

function renderExpressionsGrid(){
    const expr=getExpressions();const search=document.getElementById('exprSearch').value.toLowerCase();
    let items=Object.values(expr);
    if(search)items=items.filter(e=>e.en.toLowerCase().includes(search)||e.zh.toLowerCase().includes(search));
    items.sort((a,b)=>new Date(b.addedDate)-new Date(a.addedDate));
    const tp=Math.ceil(items.length/12);const si=(currentExprPage-1)*12;const pi=items.slice(si,si+12);
    const g=document.getElementById('expressionGrid');
    if(items.length===0){g.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ’¬</div><p>è¿˜æ²¡æœ‰ä»Šæ—¥è¡¨è¾¾</p></div>'}
    else{g.innerHTML=pi.map(e=>`<div class="expression-card-item" onclick="speakElement(this,'${escapeHtml(e.en).replace(/'/g,"\\'")}')"><div class="en">${escapeHtml(e.en)}</div><div class="zh">${escapeHtml(e.zh)}</div><div class="meta"><span>${e.addedDate}</span><span class="play-hint">ğŸ”Š æœ—è¯»</span></div></div>`).join('')}
    renderPagination('exprPagination',tp,currentExprPage,p=>{currentExprPage=p;renderExpressionsGrid()});
}
function filterExpressions(){currentExprPage=1;renderExpressionsGrid()}

function renderMemoryPage(){
    const vocab=getVocabulary();const items=Object.values(vocab);
    const counts={new:items.filter(v=>v.mastery==='new').length,learning:items.filter(v=>v.mastery==='learning').length,familiar:items.filter(v=>v.mastery==='familiar').length,mastered:items.filter(v=>v.mastery==='mastered').length};
    document.getElementById('memNewCount').textContent=counts.new;
    document.getElementById('memLearningCount').textContent=counts.learning;
    document.getElementById('memFamiliarCount').textContent=counts.familiar;
    document.getElementById('memMasteredCount').textContent=counts.mastered;
    const today=new Date().toISOString().split('T')[0];
    const dfr=items.filter(v=>v.nextReview<=today&&v.mastery!=='mastered');
    const nw=items.filter(v=>v.mastery==='new');
    const c=document.getElementById('memoryContent');
    if(reviewQueue.length>0){renderFlashcard()}
    else{c.innerHTML=`<div class="start-review"><h2>ğŸ§  å¼€å§‹è®°å¿†</h2><p>é€‰æ‹©å­¦ä¹ æ¨¡å¼</p><div class="review-options"><div class="review-option" onclick="startReview('due')"><div class="num">${dfr.length}</div><div class="label">å¾…å¤ä¹ </div></div><div class="review-option" onclick="startReview('new')"><div class="num">${nw.length}</div><div class="label">æ–°è¯</div></div><div class="review-option" onclick="startReview('all')"><div class="num">${items.length}</div><div class="label">å…¨éƒ¨</div></div><div class="review-option" onclick="startReview('random20')"><div class="num">20</div><div class="label">éšæœº</div></div></div></div>`}
}

function startReview(mode){
    const vocab=getVocabulary();const items=Object.values(vocab);const today=new Date().toISOString().split('T')[0];
    switch(mode){case'due':reviewQueue=items.filter(v=>v.nextReview<=today&&v.mastery!=='mastered');break;case'new':reviewQueue=items.filter(v=>v.mastery==='new');break;case'all':reviewQueue=[...items];break;case'random20':reviewQueue=shuffleArray([...items]).slice(0,20);break}
    if(reviewQueue.length===0){showToast('æ²¡æœ‰å¯å¤ä¹ çš„å•è¯');return}
    reviewQueue=shuffleArray(reviewQueue);currentCardIndex=0;reviewStats={again:0,hard:0,good:0,easy:0};isCardFlipped=false;renderFlashcard();
}
function shuffleArray(a){const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}

function renderFlashcard(){
    const c=document.getElementById('memoryContent');
    if(currentCardIndex>=reviewQueue.length){
        c.innerHTML=`<div class="review-complete"><div class="icon">ğŸ‰</div><h2>å®Œæˆï¼</h2><p>æœ¬æ¬¡å¤ä¹ ç»“æŸ</p><div class="review-summary"><div class="review-summary-item"><div class="num" style="color:var(--accent-red)">${reviewStats.again}</div><div class="label">å¿˜è®°</div></div><div class="review-summary-item"><div class="num" style="color:var(--accent-orange)">${reviewStats.hard}</div><div class="label">å›°éš¾</div></div><div class="review-summary-item"><div class="num" style="color:var(--accent-blue)">${reviewStats.good}</div><div class="label">è®°ä½</div></div><div class="review-summary-item"><div class="num" style="color:var(--accent-green)">${reviewStats.easy}</div><div class="label">ç®€å•</div></div></div><button class="btn btn-primary" onclick="resetReview()">ç»§ç»­å­¦ä¹ </button></div>`;
        return;
    }
    const card=reviewQueue[currentCardIndex];
    c.innerHTML=`<div class="flashcard-container"><div class="flashcard ${isCardFlipped?'flipped':''}" onclick="flipCard()">
        <div class="flashcard-progress">${currentCardIndex+1}/${reviewQueue.length}</div>
        <div class="flashcard-mastery">${getMasteryBadge(card.mastery)}</div>
        <div class="flashcard-front">
            <div class="flashcard-word" onclick="event.stopPropagation();speak('${escapeHtml(card.word).replace(/'/g,"\\'")}')">${escapeHtml(card.word)}</div>
            <div class="flashcard-phonetic">${escapeHtml(card.phonetic||'')}</div>
            <div class="flashcard-hint">ç‚¹å‡»å•è¯æœ—è¯» Â· ç‚¹å‡»å¡ç‰‡ç¿»è½¬</div>
        </div>
        <div class="flashcard-back">
            <div class="flashcard-meaning">${escapeHtml(card.meaning||'æš‚æ— é‡Šä¹‰')}</div>
            ${card.example?`<div class="flashcard-example"><div class="en">${escapeHtml(card.example)}</div>${card.exampleZh?`<div class="zh">${escapeHtml(card.exampleZh)}</div>`:''}</div>`:''}
        </div>
        <button class="flashcard-speak" onclick="event.stopPropagation();speak('${escapeHtml(card.word).replace(/'/g,"\\'")}')">ğŸ”Š æœ—è¯»</button>
    </div></div>
    <div class="memory-buttons" style="display:${isCardFlipped?'grid':'none'}">
        <button class="memory-btn again" onclick="rateCard('again')"><span class="label">å¿˜è®°äº†</span><span class="desc">1åˆ†é’Ÿ</span></button>
        <button class="memory-btn hard" onclick="rateCard('hard')"><span class="label">æœ‰ç‚¹éš¾</span><span class="desc">10åˆ†é’Ÿ</span></button>
        <button class="memory-btn good" onclick="rateCard('good')"><span class="label">è®°ä½äº†</span><span class="desc">1å¤©</span></button>
        <button class="memory-btn easy" onclick="rateCard('easy')"><span class="label">å¤ªç®€å•</span><span class="desc">4å¤©</span></button>
    </div>`;
}
function flipCard(){isCardFlipped=!isCardFlipped;renderFlashcard()}
function rateCard(rating){
    const card=reviewQueue[currentCardIndex];const vocab=getVocabulary();const k=card.word.toLowerCase();
    if(vocab[k]){
        vocab[k].reviewCount++;vocab[k].lastReview=new Date().toISOString().split('T')[0];
        const today=new Date();let nr=new Date(today);
        switch(rating){case'again':vocab[k].mastery='learning';nr.setMinutes(nr.getMinutes()+1);break;case'hard':vocab[k].mastery='learning';nr.setMinutes(nr.getMinutes()+10);break;case'good':if(vocab[k].mastery==='new')vocab[k].mastery='learning';else if(vocab[k].mastery==='learning')vocab[k].mastery='familiar';nr.setDate(nr.getDate()+1);break;case'easy':if(vocab[k].mastery==='new'||vocab[k].mastery==='learning')vocab[k].mastery='familiar';else if(vocab[k].mastery==='familiar')vocab[k].mastery='mastered';nr.setDate(nr.getDate()+4);break}
        vocab[k].nextReview=nr.toISOString().split('T')[0];saveVocabulary(vocab);
    }
    reviewStats[rating]++;currentCardIndex++;isCardFlipped=false;renderFlashcard();renderMemoryPage();
}
function resetReview(){reviewQueue=[];currentCardIndex=0;renderMemoryPage()}
function showToast(msg){const t=document.getElementById('toast');document.getElementById('toastMessage').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

document.addEventListener('DOMContentLoaded',()=>{
    syncVocabulary();syncExpressions();renderCalendar();updateStats();updateVocabCount();updateExprCount();loadRecord(selectedDate);renderWordCards();
});
document.addEventListener('keydown',e=>{
    if(reviewQueue.length>0&&isCardFlipped){switch(e.key){case'1':rateCard('again');break;case'2':rateCard('hard');break;case'3':rateCard('good');break;case'4':rateCard('easy');break}}
    else if(reviewQueue.length>0&&e.code==='Space'){e.preventDefault();flipCard()}
});
</script>
</body>
</html>
