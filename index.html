<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­ç»ƒä¹ æ—¥è®° | Daily English Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* ğŸ¨ æç®€ç™½åº•é…è‰²ç³»ç»Ÿ */
            --bg-primary: #f8f9fb;      
            --bg-card: #ffffff;         
            --bg-input: #f3f4f6;        
            --bg-hover: #f9fafb;        
            
            --text-primary: #111827;    
            --text-secondary: #4b5563;  
            --text-muted: #9ca3af;      
            
            --accent-green: #10b981;    
            --accent-blue: #3b82f6;     
            --accent-purple: #8b5cf6;   
            --accent-orange: #f97316;   
            --accent-red: #ef4444;      
            --accent-cyan: #06b6d4;     
            
            --border-color: #e5e7eb;    
            --radius-md: 12px;          
            --radius-lg: 16px;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh; 
            line-height: 1.6;
            -webkit-font-smoothing: antialiased; 
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 40px 24px; }

        header { text-align: center; margin-bottom: 40px; }
        header h1 { 
            font-family: 'Crimson Pro', serif; 
            font-size: 3rem; 
            font-weight: 600; 
            color: var(--text-primary);
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        header p { color: var(--text-secondary); font-size: 1.05rem; font-weight: 400; }

        .quick-links { display:flex; justify-content:center; gap:16px; margin-top:24px; flex-wrap:wrap; }
        .quick-link-btn {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            display:flex; align-items:center; gap:8px;
            text-decoration:none;
            box-shadow: var(--shadow-sm);
        }
        .quick-link-btn:hover { 
            background: var(--bg-card); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md);
            border-color: var(--accent-blue);
        }
        .quick-link-btn .hint { color: var(--text-muted); font-size: 0.8rem; font-weight: normal; }

        .nav-tabs { 
            display: flex; 
            justify-content: center; 
            gap: 8px; 
            margin-bottom: 32px; 
            background: rgba(229, 231, 235, 0.4); 
            padding: 6px; 
            border-radius: 16px; 
            width: fit-content; 
            margin-left: auto; 
            margin-right: auto;
            backdrop-filter: blur(8px);
        }
        .nav-tab { 
            padding: 8px 24px; 
            border-radius: 12px; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s ease; 
            font-size: 0.95rem; 
            font-weight: 500;
            border: none;
            background: transparent;
        }
        .nav-tab:hover { color: var(--text-primary); }
        .nav-tab.active { 
            background: var(--bg-card); 
            color: var(--accent-blue); 
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }
        .nav-tab .badge { 
            background: var(--bg-input); 
            color: var(--text-secondary); 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 0.75rem; 
            margin-left: 6px;
        }

        .page { display: none; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 20px 24px; 
            box-shadow: var(--shadow-md); 
            transition: all 0.3s ease; 
            border: 1px solid transparent;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stat-card .label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
        .stat-card .value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
        
        .stat-card.streak .value { color: var(--accent-orange); }
        .stat-card.total .value { color: var(--text-primary); }
        .stat-card.words .value { color: var(--accent-blue); }
        .stat-card.expressions .value { color: var(--accent-purple); }
        .stat-card.mastered .value { color: var(--accent-green); }

        .main-content { display: grid; grid-template-columns: 340px 1fr; gap: 32px; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }

        .calendar-section { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 24px; 
            box-shadow: var(--shadow-md); 
            height: fit-content; 
            position: sticky; 
            top: 24px; 
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .calendar-nav button { 
            background: var(--bg-input); 
            border: none; 
            color: var(--text-secondary); 
            width: 32px; height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .calendar-nav button:hover { background: var(--border-color); color: var(--text-primary); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 12px; }
        .weekday { text-align: center; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 10px; 
            font-size: 0.85rem; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            position: relative; 
            color: var(--text-secondary);
        }
        .day:hover:not(.empty) { background: var(--bg-input); color: var(--text-primary); }
        .day.today { color: var(--accent-blue); font-weight: 700; background: rgba(59, 130, 246, 0.1); }
        .day.selected { background: var(--accent-blue); color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .day.has-record::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; background: var(--accent-green); border-radius: 50%; }
        .day.selected.has-record::after { background: white; }
        .day.other-month { color: #d1d5db; }

        .record-section { display: flex; flex-direction: column; gap: 24px; }
        .record-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 28px; 
            box-shadow: var(--shadow-md); 
            border: 1px solid rgba(255,255,255,0.5);
        }
        .record-card h3 { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 16px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: var(--text-primary);
        }
        .auto-badge { 
            font-size: 0.65rem; 
            background: rgba(6, 182, 212, 0.1); 
            color: var(--accent-cyan); 
            padding: 3px 8px; 
            border-radius: 6px; 
            font-weight: 600; 
            letter-spacing: 0.5px;
        }

        .conversation-input {
            width: 100%;
            min-height: 200px;
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.2s ease;
            line-height: 1.7;
        }
        .conversation-input:focus { background: white; border-color: var(--accent-blue); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .conversation-input::placeholder { color: var(--text-muted); }

        .extract-section { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
        .extract-btn { 
            padding: 10px 18px; 
            border-radius: 10px; 
            border: none; 
            background: white; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s ease; 
            font-size: 0.85rem; 
            font-weight: 500;
            display: flex; 
            align-items: center; 
            gap: 8px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .extract-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); box-shadow: var(--shadow-md); transform: translateY(-1px); }

        .word-cards { display: flex; flex-direction: column; gap: 16px; }
        .word-card { 
            background: white; 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md); 
            padding: 20px; 
            transition: all 0.2s ease; 
            position: relative;
        }
        .word-card:hover { border-color: var(--accent-blue); box-shadow: var(--shadow-md); }
        .word-card.loading { opacity: 0.6; pointer-events: none; }
        
        .word-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .word-card-word { 
            font-family: 'Crimson Pro', serif; 
            font-size: 1.5rem; 
            color: var(--text-primary); 
            font-weight: 600;
            cursor: pointer; 
        }
        .word-card-word:hover { color: var(--accent-blue); }
        .word-card-phonetic { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-muted); margin-left: 10px; background: var(--bg-input); padding: 2px 6px; border-radius: 4px; }
        
        .word-card-actions button { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 6px; border-radius: 6px; transition: 0.2s; }
        .word-card-actions button:hover { background: var(--bg-input); color: var(--accent-red); }
        .word-card-actions button.refresh:hover { color: var(--accent-blue); }

        .word-card-meaning { 
            font-size: 0.95rem; 
            color: var(--text-secondary); 
            margin-bottom: 12px; 
            padding-left: 12px; 
            border-left: 3px solid var(--accent-blue); 
            line-height: 1.6;
        }
        .word-card-meaning-en { margin-top: 4px; font-size: 0.85rem; color: var(--text-muted); }
        
        .word-card-input { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color); }
        .word-card-input input, .word-card-input textarea { 
            background: var(--bg-input); 
            border: 1px solid transparent; 
            border-radius: 8px; 
            padding: 10px 12px; 
            color: var(--text-primary); 
            font-family: inherit; 
            font-size: 0.9rem; 
            transition: 0.2s; 
        }
        .word-card-input input:focus, .word-card-input textarea:focus { background: white; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .word-card-input .row { display: flex; gap: 10px; }
        .word-card-input .row input:first-child { flex: 1; font-family: 'Crimson Pro', serif; font-weight: 500; font-size: 1.1rem; }
        .word-card-input .row input:last-child { width: 140px; font-family: 'JetBrains Mono', monospace; }
        
        .add-btn { 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            background: white; border: 2px dashed var(--border-color); 
            border-radius: var(--radius-md); padding: 14px; 
            color: var(--text-secondary); cursor: pointer; 
            transition: all 0.2s ease; font-weight: 500; margin-top: 16px;
        }
        .add-btn:hover { border-color: var(--accent-green); color: var(--accent-green); background: rgba(16, 185, 129, 0.05); }

        .expression-list { display: flex; flex-direction: column; gap: 12px; }
        .vocab-item { display: flex; gap: 10px; align-items: flex-start; }
        .sentence-input-group { display: flex; flex-direction: column; gap: 8px; flex: 1; background: var(--bg-input); padding: 12px; border-radius: 10px; }
        .sentence-input-group input { 
            width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(0,0,0,0.05); 
            padding: 4px 0; color: var(--text-primary); font-size: 0.95rem; 
        }
        .sentence-input-group input:focus { border-bottom-color: var(--accent-purple); }
        .sentence-input-group input.en { font-family: 'Crimson Pro', serif; font-size: 1.05rem; color: var(--text-primary); font-weight: 500; }
        .vocab-item .delete-btn { opacity: 0.5; cursor: pointer; border: none; background: transparent; font-size: 1.2rem; }
        .vocab-item .delete-btn:hover { opacity: 1; color: var(--accent-red); }

        .expression-item { 
            background: white; border: 1px solid var(--border-color); 
            border-radius: 10px; padding: 14px 18px; 
            cursor: pointer; transition: all 0.2s ease; 
            box-shadow: var(--shadow-sm); 
        }
        .expression-item:hover { transform: translateX(4px); border-color: var(--accent-cyan); box-shadow: var(--shadow-md); }
        .expression-item .en { font-family: 'Crimson Pro', serif; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 4px; font-weight: 500; }
        .expression-item .zh { font-size: 0.9rem; color: var(--text-secondary); }

        .save-section { display: flex; gap: 12px; justify-content: flex-end; margin-top: 12px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .btn { padding: 12px 24px; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; border: none; }
        .btn-primary { background: var(--text-primary); color: white; box-shadow: var(--shadow-md); }
        .btn-primary:hover { background: black; transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--bg-input); color: var(--text-primary); }

        .vocab-page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .vocab-page-header h2 { font-size: 1.5rem; color: var(--text-primary); }
        .search-box input { 
            background: white; border: 1px solid var(--border-color); 
            border-radius: 50px; padding: 10px 20px 10px 40px; 
            color: var(--text-primary); width: 220px; box-shadow: var(--shadow-sm); 
            transition: 0.2s;
        }
        .search-box input:focus { width: 260px; border-color: var(--accent-blue); box-shadow: var(--shadow-md); }
        .search-box::before { content: 'ğŸ”'; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0.5; z-index: 2; }
        .filter-select { background: white; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 16px; color: var(--text-primary); cursor: pointer; box-shadow: var(--shadow-sm); }

        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .vocab-grid-card { 
            background: white; border-radius: var(--radius-lg); 
            padding: 24px; transition: all 0.3s ease; 
            cursor: pointer; box-shadow: var(--shadow-md);
            border: 1px solid transparent;
        }
        .vocab-grid-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .vocab-grid-word { font-family: 'Crimson Pro', serif; font-size: 1.6rem; color: var(--text-primary); font-weight: 600; }
        .vocab-grid-phonetic { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-muted); margin-left: 8px; background: var(--bg-input); padding: 2px 6px; border-radius: 4px; }
        .vocab-grid-meaning { font-size: 1rem; color: var(--text-secondary); margin: 12px 0 6px 0; }
        .vocab-grid-example { 
            font-size: 0.9rem; color: var(--text-secondary); 
            padding: 12px; background: var(--bg-input); 
            border-radius: 8px; margin-top: 12px;
            font-style: italic;
        }
        .vocab-grid-footer { display: flex; justify-content: space-between; margin-top: 16px; font-size: 0.8rem; color: var(--text-muted); border-top: 1px solid var(--bg-input); padding-top: 12px; }

        .mastery-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .mastery-badge.new { background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); }
        .mastery-badge.learning { background: rgba(249, 115, 22, 0.1); color: var(--accent-orange); }
        .mastery-badge.familiar { background: rgba(139, 92, 246, 0.1); color: var(--accent-purple); }
        .mastery-badge.mastered { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); }

        .pagination button { background: white; border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .pagination button:hover:not(:disabled) { background: var(--bg-input); }

        .memory-mode-container { max-width: 700px; margin: 0 auto; }
        .memory-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
        .memory-stat { background: white; border-radius: 16px; padding: 16px; text-align: center; box-shadow: var(--shadow-sm); }
        .memory-stat .num { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
        
        .flashcard-container { perspective: 1000px; margin-bottom: 32px; }
        .flashcard { 
            background: white; 
            border-radius: 24px; 
            min-height: 400px; 
            padding: 40px; 
            cursor: pointer; 
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s; 
            transform-style: preserve-3d; 
            position: relative; 
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        .flashcard:hover { box-shadow: var(--shadow-hover); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { 
            position: absolute; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            backface-visibility: hidden; padding: 40px; left: 0; top: 0; 
        }
        .flashcard-back { transform: rotateY(180deg); background: white; border-radius: 24px; }
        
        .flashcard-word { font-family: 'Crimson Pro', serif; font-size: 3.5rem; color: var(--text-primary); margin-bottom: 12px; font-weight: 600; }
        .flashcard-phonetic { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: var(--text-secondary); background: var(--bg-input); padding: 4px 12px; border-radius: 20px; }
        .flashcard-hint { margin-top: 32px; font-size: 0.9rem; color: var(--text-muted); }
        
        .flashcard-meaning { font-size: 1.6rem; color: var(--text-primary); text-align: center; margin-bottom: 20px; font-weight: 500; }
        .flashcard-example { background: var(--bg-input); padding: 20px; border-radius: 12px; text-align: center; width: 100%; }
        
        .memory-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .memory-btn { 
            padding: 16px; border-radius: 16px; border: none; 
            cursor: pointer; transition: all 0.2s ease; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            background: white; box-shadow: var(--shadow-md); color: var(--text-primary);
        }
        .memory-btn:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .memory-btn.again:hover { background: #fee2e2; color: var(--accent-red); }
        .memory-btn.hard:hover { background: #ffedd5; color: var(--accent-orange); }
        .memory-btn.good:hover { background: #dbeafe; color: var(--accent-blue); }
        .memory-btn.easy:hover { background: #d1fae5; color: var(--accent-green); }

        .start-review { text-align: center; padding: 60px 20px; background: white; border-radius: 24px; box-shadow: var(--shadow-md); }
        .review-options { display: flex; justify-content: center; gap: 20px; margin-top: 32px; }
        .review-option { 
            background: var(--bg-input); border-radius: 16px; padding: 20px 32px; 
            cursor: pointer; transition: 0.2s; min-width: 140px; 
        }
        .review-option:hover { background: white; box-shadow: var(--shadow-lg); transform: translateY(-4px); }
        .review-option .num { font-size: 2.2rem; font-weight: 700; color: var(--text-primary); }

        .toast { 
            position: fixed; bottom: 32px; right: 32px; 
            background: white; color: var(--text-primary);
            border-radius: 12px; padding: 16px 24px; 
            box-shadow: var(--shadow-lg); 
            display: flex; align-items: center; gap: 12px; 
            transform: translateY(100px); opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 1000; font-weight: 500;
            border: 1px solid var(--border-color);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        
        .speech-control { 
            position: fixed; bottom: 32px; left: 32px; 
            background: white; border-radius: 50px; 
            padding: 12px 20px; display: flex; align-items: center; gap: 12px; 
            box-shadow: var(--shadow-lg); z-index: 100; 
            border: 1px solid var(--border-color);
        }

        /* âœ… æ–°å¢ï¼šå¤‡ä»½/æ¢å¤æŒ‰é’®æ ·å¼ */
        .backup-section {
            display: flex; justify-content: center; gap: 16px; margin-top: 40px;
            padding-top: 30px; border-top: 1px solid var(--border-color);
        }
        .backup-btn {
            background: var(--bg-input); border: 1px solid var(--border-color);
            padding: 10px 20px; border-radius: 10px; color: var(--text-secondary);
            cursor: pointer; transition: 0.2s; font-size: 0.85rem;
            display: flex; align-items: center; gap: 8px;
        }
        .backup-btn:hover { background: var(--bg-hover); color: var(--text-primary); transform: translateY(-1px); }

        @media (max-width: 768px) {
            .container { padding: 20px 16px; }
            header h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .calendar-section { position: static; }
            .vocab-grid { grid-template-columns: 1fr; }
            .memory-stats { grid-template-columns: repeat(2, 1fr); }
            .memory-buttons { grid-template-columns: repeat(2, 1fr); }
            .backup-section { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Daily English Journal</h1>
            <p>æ¯å¤©30åˆ†é’Ÿï¼Œè®°å½•ä¸AIçš„è‹±è¯­å¯¹è¯</p>

            <div class="quick-links">
                <a class="quick-link-btn" href="https://chatgpt.com/" target="_blank" rel="noopener noreferrer">
                    ğŸ¤– ChatGPT <span class="hint">App / Web</span>
                </a>
                <a class="quick-link-btn" href="https://www.youtube.com/" target="_blank" rel="noopener noreferrer">
                    â–¶ï¸ YouTube <span class="hint">æ‰¾ç´ æç»ƒå¬åŠ›</span>
                </a>
            </div>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchPage('journal')">ğŸ“… æ¯æ—¥è®°å½•</div>
            <div class="nav-tab" onclick="switchPage('vocabulary')">ğŸ“š ç”Ÿè¯åº“ <span class="badge" id="vocabCount">0</span></div>
            <div class="nav-tab" onclick="switchPage('expressions')">ğŸ’¬ ä»Šæ—¥è¡¨è¾¾ <span class="badge" id="exprCount">0</span></div>
            <div class="nav-tab" onclick="switchPage('memory')">ğŸ§  è®°å¿†æ¨¡å¼</div>
        </div>

        <div class="page active" id="journalPage">
            <div class="stats-grid">
                <div class="stat-card streak"><div class="label">ğŸ”¥ è¿ç»­æ‰“å¡</div><div class="value" id="streakDays">0</div></div>
                <div class="stat-card total"><div class="label">ğŸ“… ç´¯è®¡å¤©æ•°</div><div class="value" id="totalDays">0</div></div>
                <div class="stat-card words"><div class="label">ğŸ“š ç”Ÿè¯æ•°é‡</div><div class="value" id="totalWords">0</div></div>
                <div class="stat-card expressions"><div class="label">ğŸ’¬ ä»Šæ—¥è¡¨è¾¾</div><div class="value" id="totalExpressions">0</div></div>
                <div class="stat-card mastered"><div class="label">ğŸ† å·²æŒæ¡</div><div class="value" id="masteredWords">0</div></div>
            </div>

            <div class="main-content">
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-title" id="calendarTitle">2024å¹´1æœˆ</div>
                        <div class="calendar-nav"><button onclick="prevMonth()">â€¹</button><button onclick="nextMonth()">â€º</button></div>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="weekday">æ—¥</div><div class="weekday">ä¸€</div><div class="weekday">äºŒ</div><div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div>
                    </div>
                    <div class="calendar-days" id="calendarDays"></div>
                </div>

                <div class="record-section">
                    <div class="record-card">
                        <h3><span>ğŸ’¬</span> ä»Šæ—¥å¯¹è¯å†…å®¹ <span class="auto-badge">æ™ºèƒ½æå–</span></h3>
                        <textarea class="conversation-input" id="conversationInput" placeholder="ç²˜è´´ä»Šå¤©å’ŒChatGPTçš„å¯¹è¯å†…å®¹...&#10;&#10;ç‚¹å‡»ã€Œæå–ç”Ÿè¯ã€è‡ªåŠ¨è·å–ï¼š&#10;â€¢ å•è¯ã€éŸ³æ ‡ã€é‡Šä¹‰ï¼ˆä¸­æ–‡+è‹±æ–‡ï¼‰ã€ä¾‹å¥ï¼ˆè‹±æ–‡+ä¸­æ–‡ï¼‰"></textarea>
                        <div class="extract-section">
                            <button class="extract-btn" onclick="extractVocabulary()" id="extractVocabBtn"><span>ğŸ“–</span> æå–ç”Ÿè¯ï¼ˆè‡ªåŠ¨æŸ¥è¯å…¸+ä¸­æ–‡ç¿»è¯‘ï¼‰</button>
                            <button class="extract-btn" onclick="extractExpressions()" id="extractExprBtn"><span>ğŸ’¡</span> æå–è¡¨è¾¾</button>
                        </div>
                    </div>

                    <div class="record-card">
                        <h3><span>ğŸ“–</span> ç”Ÿè¯è®°å½• <span class="auto-badge">å«éŸ³æ ‡+ä¸­è‹±é‡Šä¹‰+ä¾‹å¥</span></h3>
                        <div class="word-cards" id="wordCards"></div>
                        <button class="add-btn" onclick="addWordCard()"><span>+</span> æ‰‹åŠ¨æ·»åŠ ç”Ÿè¯</button>
                    </div>

                    <div class="record-card expression-card">
                        <h3><span>ğŸ’¬</span> ä»Šæ—¥è¡¨è¾¾ <span class="auto-badge">ç‚¹å‡»æœ—è¯»</span></h3>
                        <div class="expression-list" id="expressionsList">
                            <div class="vocab-item">
                                <div class="sentence-input-group">
                                    <input type="text" class="en" placeholder="English expression">
                                    <input type="text" class="zh" placeholder="ä¸­æ–‡ç¿»è¯‘">
                                </div>
                                <button class="delete-btn" onclick="deleteExpression(this)">Ã—</button>
                            </div>
                        </div>
                        <button class="add-btn" onclick="addExpression()"><span>+</span> æ·»åŠ è¡¨è¾¾</button>
                    </div>

                    <div class="save-section">
                        <button class="btn btn-secondary" onclick="clearForm()">æ¸…ç©º</button>
                        <button class="btn btn-primary" onclick="saveRecord()"><span>ğŸ’¾</span> ä¿å­˜è®°å½•</button>
                    </div>

                    <div id="historyPreview"></div>
                </div>
            </div>
            
            <div class="backup-section">
                <button class="backup-btn" onclick="exportData()">â¬‡ï¸ å¤‡ä»½æ•°æ® (å¯¼å‡º JSON)</button>
                <button class="backup-btn" onclick="document.getElementById('importFile').click()">â¬†ï¸ æ¢å¤æ•°æ® (å¯¼å…¥ JSON)</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">
            </div>
            <div style="text-align:center;font-size:0.75rem;color:var(--text-muted);margin-top:10px">
                âš ï¸ æ³¨æ„ï¼šæœ¬ç½‘ç«™æ˜¯çº¯é™æ€çš„ï¼Œæ•°æ®ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨ç¼“å­˜ä¸­ã€‚<br>
                å¦‚æœæ›´æ¢è®¾å¤‡æˆ–æ¸…ç†ç¼“å­˜ï¼Œè¯·åŠ¡å¿…å…ˆç‚¹å‡»ã€Œå¤‡ä»½æ•°æ®ã€ã€‚
            </div>
        </div>

        <div class="page" id="vocabularyPage">
            <div class="vocab-page-header">
                <h2>ğŸ“š æˆ‘çš„ç”Ÿè¯åº“</h2>
                <div class="vocab-controls" style="display:flex;gap:12px">
                    <div class="search-box"><input type="text" id="vocabSearch" placeholder="æœç´¢..." oninput="filterVocab()"></div>
                    <select class="filter-select" id="masteryFilter" onchange="filterVocab()">
                        <option value="all">å…¨éƒ¨</option><option value="new">ğŸ†• æ–°è¯</option><option value="learning">ğŸ“– å­¦ä¹ ä¸­</option><option value="familiar">ğŸ’¡ ç†Ÿæ‚‰</option><option value="mastered">âœ… å·²æŒæ¡</option>
                    </select>
                </div>
            </div>
            <div class="vocab-grid" id="vocabGrid"></div>
            <div class="pagination" id="vocabPagination"></div>
        </div>

        <div class="page" id="expressionsPage">
            <div class="vocab-page-header">
                <h2>ğŸ’¬ ä»Šæ—¥è¡¨è¾¾åº“ <span style="font-size:0.9rem;color:var(--text-muted);font-weight:400;margin-left:8px">ç‚¹å‡»å¡ç‰‡æœ—è¯»</span></h2>
                <div class="vocab-controls"><div class="search-box"><input type="text" id="exprSearch" placeholder="æœç´¢..." oninput="filterExpressions()"></div></div>
            </div>
            <div class="expression-grid" id="expressionGrid"></div>
            <div class="pagination" id="exprPagination"></div>
        </div>

        <div class="page" id="memoryPage">
            <div class="memory-mode-container">
                <div class="memory-stats">
                    <div class="memory-stat new"><div class="num" id="memNewCount" style="color:var(--accent-blue)">0</div><div class="label">æ–°è¯</div></div>
                    <div class="memory-stat learning"><div class="num" id="memLearningCount" style="color:var(--accent-orange)">0</div><div class="label">å­¦ä¹ ä¸­</div></div>
                    <div class="memory-stat familiar"><div class="num" id="memFamiliarCount" style="color:var(--accent-purple)">0</div><div class="label">ç†Ÿæ‚‰</div></div>
                    <div class="memory-stat mastered"><div class="num" id="memMasteredCount" style="color:var(--accent-green)">0</div><div class="label">å·²æŒæ¡</div></div>
                </div>
                <div id="memoryContent"></div>
            </div>
        </div>
    </div>

    <div class="speech-control">
        <label>ğŸ”Š è¯­é€Ÿ</label>
        <input type="range" id="speechRate" min="0.3" max="1" step="0.1" value="0.6" oninput="updateSpeechRate()">
        <span class="speed-value" id="speedValue">0.6x</span>
    </div>
    <div class="toast" id="toast"><span class="icon">âœ“</span><span id="toastMessage">æˆåŠŸ</span></div>

<script>
const STORAGE_KEY='english_journal_data',VOCAB_KEY='english_vocabulary_data',EXPR_KEY='english_expressions_data';
const TRANSLATE_CACHE_KEY='english_translate_cache_v1';

function getLocalDateString(dateObj) {
    const d = dateObj || new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getTranslateCache(){
    try { return JSON.parse(localStorage.getItem(TRANSLATE_CACHE_KEY)||'{}'); }
    catch(e){ return {}; }
}
function saveTranslateCache(cache){
    localStorage.setItem(TRANSLATE_CACHE_KEY, JSON.stringify(cache));
}

async function translateToZh(text){
    const t=(text||'').trim();
    if(!t) return '';
    const cache=getTranslateCache();
    const key='en2zh:'+t.slice(0,300);
    if(cache[key]) return cache[key];

    try{
        const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(t)}&langpair=en|zh-CN`;
        const res=await fetch(url);
        if(!res.ok) return '';
        const data=await res.json();
        const zh=((data && data.responseData && data.responseData.translatedText) || '').trim();
        if(zh){
            cache[key]=zh;
            saveTranslateCache(cache);
            return zh;
        }
        return '';
    }catch(e){
        console.error('Translate failed:', e);
        return '';
    }
}

let currentYear=new Date().getFullYear(),currentMonth=new Date().getMonth();
let selectedDate = getLocalDateString();

let currentVocabPage=1,currentExprPage=1,PER_PAGE=12,speechRate=0.6,currentSpeaking=null;
let reviewQueue=[],currentCardIndex=0,reviewStats={again:0,hard:0,good:0,easy:0},isCardFlipped=false;
let wordCardsData=[];

const commonWords=new Set(['the','a','an','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','shall','can','need','to','of','in','for','on','with','at','by','from','up','about','into','over','after','under','i','you','he','she','it','we','they','me','him','her','us','them','my','your','his','its','our','their','this','that','these','those','what','which','who','where','when','why','how','all','each','every','both','few','more','most','other','some','no','not','only','same','so','than','too','very','just','also','now','here','there','then','and','but','or','if','because','as','until','while','although','though','before','since','unless','however','therefore','like','get','got','make','made','go','went','come','came','take','took','see','saw','know','knew','think','thought','want','say','said','tell','told','use','used','find','found','give','gave','let','put','seem','leave','left','call','called','keep','kept','try','tried','ask','asked','work','worked','become','became','look','looked','show','showed','hear','heard','play','played','run','ran','move','moved','live','lived','believe','believed','hold','held','bring','brought','happen','happened','write','wrote','provide','provided','sit','sat','stand','stood','lose','lost','pay','paid','meet','met','include','included','continue','continued','set','learn','learned','change','changed','lead','led','understand','understood','watch','watched','follow','followed','stop','stopped','create','created','speak','spoke','read','allow','allowed','add','added','spend','spent','grow','grew','open','opened','walk','walked','win','won','offer','offered','remember','remembered','love','loved','consider','considered','appear','appeared','buy','bought','wait','waited','serve','served','die','died','send','sent','expect','expected','build','built','stay','stayed','fall','fell','cut','reach','reached','kill','killed','remain','remained','suggest','suggested','raise','raised','pass','passed','sell','sold','require','required','report','reported','decide','decided','pull','pulled']);

function speak(text,onEnd){if('speechSynthesis'in window){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.lang='en-US';u.rate=speechRate;const v=window.speechSynthesis.getVoices(),ev=v.find(x=>x.lang.includes('en'));if(ev)u.voice=ev;u.onend=()=>{if(currentSpeaking){currentSpeaking.classList.remove('speaking');currentSpeaking=null}if(onEnd)onEnd()};window.speechSynthesis.speak(u)}}
function speakElement(el,text){if(currentSpeaking){currentSpeaking.classList.remove('speaking');window.speechSynthesis.cancel();if(currentSpeaking===el){currentSpeaking=null;return}}currentSpeaking=el;el.classList.add('speaking');speak(text)}
function updateSpeechRate(){speechRate=parseFloat(document.getElementById('speechRate').value);document.getElementById('speedValue').textContent=speechRate+'x'}
if('speechSynthesis'in window){window.speechSynthesis.getVoices();window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices()}

function getAllRecords(){
    try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    } catch(e) {
        console.error('Error reading records:', e);
        return {};
    }
}
function saveAllRecords(r){
    try {
        localStorage.setItem(STORAGE_KEY,JSON.stringify(r));
        console.log('Records saved successfully');
    } catch(e) {
        console.error('Error saving records:', e);
        alert('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³');
    }
}
function getVocabulary(){return JSON.parse(localStorage.getItem(VOCAB_KEY)||'{}')}
function saveVocabulary(v){localStorage.setItem(VOCAB_KEY,JSON.stringify(v))}
function getExpressions(){return JSON.parse(localStorage.getItem(EXPR_KEY)||'{}')}
function saveExpressions(e){localStorage.setItem(EXPR_KEY,JSON.stringify(e))}
function getRecord(d){return getAllRecords()[d]||null}

/* âœ… æ–°å¢ï¼šå¯¼å‡ºæ•°æ®åŠŸèƒ½ */
function exportData() {
    const data = {
        records: getAllRecords(),
        vocabulary: getVocabulary(),
        expressions: getExpressions(),
        cache: getTranslateCache()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `english-journal-backup-${getLocalDateString()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½');
}

/* âœ… æ–°å¢ï¼šå¯¼å…¥æ•°æ®åŠŸèƒ½ */
function importData(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.records) saveAllRecords(data.records);
            if (data.vocabulary) saveVocabulary(data.vocabulary);
            if (data.expressions) saveExpressions(data.expressions);
            if (data.cache) saveTranslateCache(data.cache);
            
            showToast('æ•°æ®æ¢å¤æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...');
            setTimeout(() => location.reload(), 1000);
        } catch (err) {
            alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•å¯¼å…¥');
            console.error(err);
        }
    };
    reader.readAsText(file);
    // é‡ç½® input ä»¥ä¾¿é‡å¤å¯¼å…¥åŒåæ–‡ä»¶
    input.value = '';
}

async function lookupWord(word){
    try{
        const res=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word.toLowerCase())}`);
        if(!res.ok)return null;
        const data=await res.json();
        if(!data||!data[0])return null;
        const entry=data[0];

        let phonetic='';
        if(entry.phonetic) phonetic=entry.phonetic;
        else if(entry.phonetics&&entry.phonetics.length>0){
            const p=entry.phonetics.find(x=>x.text)||entry.phonetics[0];
            if(p.text)phonetic=p.text;
        }

        let meaningEn='';
        let meaningZh='';
        let example='';
        let exampleZh='';

        if(entry.meanings&&entry.meanings.length>0){
            const m=entry.meanings[0];
            const partOfSpeech=m.partOfSpeech||'';
            if(m.definitions&&m.definitions.length>0){
                const def=m.definitions[0];
                meaningEn=(partOfSpeech?`[${partOfSpeech}] `:'')+(def.definition||'');
                if(def.example) example=def.example;
            }
        }

        if(meaningEn){
            meaningZh = await translateToZh(meaningEn);
        }
        if(example){
            exampleZh = await translateToZh(example);
        }

        return{
            word:entry.word||word,
            phonetic,
            meaningEn,
            meaningZh,
            example,
            exampleZh
        };
    }catch(e){
        console.error('Dictionary lookup failed:',e);
        return null;
    }
}

async function extractVocabulary(){
    const btn=document.getElementById('extractVocabBtn');
    btn.classList.add('extracting');
    btn.innerHTML='<span>â³</span> æå–å¹¶æŸ¥è¯¢...';

    const text=document.getElementById('conversationInput').value;
    const words=extractWordsFromText(text);

    if(words.length===0){
        showToast('æœªæ‰¾åˆ°ç”Ÿè¯');
        btn.classList.remove('extracting');
        btn.innerHTML='<span>ğŸ“–</span> æå–ç”Ÿè¯ï¼ˆè‡ªåŠ¨æŸ¥è¯å…¸+ä¸­æ–‡ç¿»è¯‘ï¼‰';
        return;
    }

    wordCardsData=[];
    for(let i=0;i<Math.min(words.length,10);i++){
        const w=words[i];
        wordCardsData.push({
            id:Date.now()+i,
            word:w.word,
            phonetic:'',
            meaning:'',
            meaningEn:'',
            example:'',
            exampleZh:'',
            loading:true
        });
    }
    renderWordCards();

    for(let i=0;i<wordCardsData.length;i++){
        const card=wordCardsData[i];
        const dictData=await lookupWord(card.word);

        if(dictData){
            card.phonetic=dictData.phonetic||'';
            card.meaningEn=dictData.meaningEn||'';
            if(dictData.meaningZh) card.meaning=dictData.meaningZh;
            card.example=dictData.example||'';
            card.exampleZh=dictData.exampleZh||'';
        }

        card.loading=false;
        renderWordCards();
        await new Promise(r=>setTimeout(r,220));
    }

    showToast(`æå– ${wordCardsData.length} ä¸ªç”Ÿè¯`);
    btn.classList.remove('extracting');
    btn.innerHTML='<span>ğŸ“–</span> æå–ç”Ÿè¯ï¼ˆè‡ªåŠ¨æŸ¥è¯å…¸+ä¸­æ–‡ç¿»è¯‘ï¼‰';
}

function extractWordsFromText(text){
    const words=[],seen=new Set();
    const p1=/["']?([a-zA-Z][a-zA-Z-]{2,20})["']?\s*[-â€“â€”:ï¼š]\s*([^\n]+)/g;
    let m;
    while((m=p1.exec(text))!==null){
        const w=m[1].trim().toLowerCase(),mg=m[2].trim();
        if(w.length>2&&!commonWords.has(w)&&!seen.has(w)){seen.add(w);words.push({word:m[1].trim(),meaning:mg})}
    }
    const p2=/\b([a-zA-Z]{5,15})\b/g;
    while((m=p2.exec(text))!==null){
        const w=m[1].toLowerCase();
        if(!commonWords.has(w)&&!seen.has(w)&&!/^[A-Z]/.test(m[1])){seen.add(w);words.push({word:m[1],meaning:''})}
    }
    return words.slice(0,10);
}

function renderWordCards(){
    const container=document.getElementById('wordCards');
    if(wordCardsData.length===0){
        container.innerHTML='<div class="empty-state" style="padding:20px;text-align:center;color:var(--text-muted)"><p>æš‚æ— ç”Ÿè¯ï¼Œç‚¹å‡»ã€Œæå–ç”Ÿè¯ã€æˆ–ã€Œæ‰‹åŠ¨æ·»åŠ ã€</p></div>';
        return;
    }
    container.innerHTML=wordCardsData.map((card,idx)=>`
        <div class="word-card ${card.loading?'loading':''}" data-idx="${idx}">
            <div class="word-card-header">
                <div class="word-card-main">
                    <span class="word-card-word" onclick="speak('${escapeHtml(card.word)}')">${escapeHtml(card.word)}</span>
                    <span class="word-card-phonetic">${escapeHtml(card.phonetic)}</span>
                </div>
                <div class="word-card-actions">
                    <button class="refresh" onclick="refreshWordCard(${idx})" title="é‡æ–°æŸ¥è¯¢">ğŸ”„</button>
                    <button onclick="deleteWordCard(${idx})" title="åˆ é™¤">Ã—</button>
                </div>
            </div>

            ${card.meaning ? `<div class="word-card-meaning">
                ${escapeHtml(card.meaning)}
                ${card.meaningEn ? `<div class="word-card-meaning-en">EN: ${escapeHtml(card.meaningEn)}</div>` : ``}
            </div>` : ``}

            <div class="word-card-input">
                <div class="row">
                    <input type="text" value="${escapeHtml(card.word)}" onchange="updateWordCard(${idx},'word',this.value)" placeholder="å•è¯">
                    <input type="text" value="${escapeHtml(card.phonetic)}" onchange="updateWordCard(${idx},'phonetic',this.value)" placeholder="éŸ³æ ‡">
                </div>
                <input type="text" value="${escapeHtml(card.meaning)}" onchange="updateWordCard(${idx},'meaning',this.value)" placeholder="ä¸­æ–‡é‡Šä¹‰ï¼ˆè‡ªåŠ¨ç¿»è¯‘ï¼Œå¯ç¼–è¾‘ï¼‰">
                <input type="text" value="${escapeHtml(card.meaningEn||'')}" onchange="updateWordCard(${idx},'meaningEn',this.value)" placeholder="è‹±æ–‡é‡Šä¹‰ï¼ˆå‚è€ƒï¼Œå¯ç¼–è¾‘ï¼‰">
                <textarea onchange="updateWordCard(${idx},'example',this.value)" placeholder="ä¾‹å¥ï¼ˆè‹±æ–‡ï¼‰" rows="2">${escapeHtml(card.example)}</textarea>
                <input type="text" value="${escapeHtml(card.exampleZh)}" onchange="updateWordCard(${idx},'exampleZh',this.value)" placeholder="ä¾‹å¥ç¿»è¯‘ï¼ˆä¸­æ–‡ï¼‰">
            </div>
            ${card.loading?'<div style="font-size:0.8rem;color:var(--accent-blue);margin-top:8px">â³ æ­£åœ¨æŸ¥è¯¢è¯å…¸...</div>':''}
        </div>
    `).join('');
}

function updateWordCard(idx,field,value){wordCardsData[idx][field]=value}
function deleteWordCard(idx){wordCardsData.splice(idx,1);renderWordCards()}

async function refreshWordCard(idx){
    const card=wordCardsData[idx];
    card.loading=true;
    renderWordCards();

    const dictData=await lookupWord(card.word);
    if(dictData){
        card.phonetic=dictData.phonetic||card.phonetic;
        card.meaningEn=dictData.meaningEn||card.meaningEn||'';
        if(dictData.meaningZh) card.meaning=dictData.meaningZh||card.meaning;
        card.example=dictData.example||card.example;
        if(dictData.exampleZh) card.exampleZh=dictData.exampleZh||card.exampleZh;
    }

    card.loading=false;
    renderWordCards();
    showToast('å·²æ›´æ–°');
}

function addWordCard(){
    wordCardsData.push({id:Date.now(),word:'',phonetic:'',meaning:'',meaningEn:'',example:'',exampleZh:'',loading:false});
    renderWordCards();
}

function extractExpressions(){
    const btn=document.getElementById('extractExprBtn');
    btn.classList.add('extracting');
    btn.innerHTML='<span>â³</span> æå–ä¸­...';
    const text=document.getElementById('conversationInput').value;
    setTimeout(()=>{
        const expr=extractExpressionsFromText(text);
        if(expr.length>0){
            const list=document.getElementById('expressionsList');
            const items=list.querySelectorAll('.vocab-item');
            const first=items[0];
            if(first&&!first.querySelector('.en').value&&!first.querySelector('.zh').value&&items.length===1)list.innerHTML='';
            expr.forEach(e=>{
                const item=document.createElement('div');
                item.className='vocab-item';
                item.innerHTML=`<div class="sentence-input-group"><input type="text" class="en" value="${escapeHtml(e.en)}"><input type="text" class="zh" value="${escapeHtml(e.zh||'')}"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button>`;
                list.appendChild(item);
            });
            showToast(`æå– ${expr.length} ä¸ªè¡¨è¾¾`);
        }else{showToast('æœªæ‰¾åˆ°è¡¨è¾¾')}
        btn.classList.remove('extracting');
        btn.innerHTML='<span>ğŸ’¡</span> æå–è¡¨è¾¾';
    },400);
}

function extractExpressionsFromText(text){
    const expr=[],seen=new Set();
    const sentences=text.split(/[.!?ã€‚ï¼ï¼Ÿ]+/).filter(s=>s.trim().length>10);
    sentences.forEach(s=>{
        const t=s.trim();
        if(/^[A-Z][a-zA-Z\s,'"'-]+/.test(t)&&t.length>15&&t.length<120){
            const l=t.toLowerCase();
            if(!seen.has(l)){seen.add(l);expr.push({en:t,zh:''})}
        }
    });
    return expr.slice(0,12);
}

function switchPage(page){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(page+'Page').classList.add('active');
    event.target.closest('.nav-tab').classList.add('active');
    if(page==='vocabulary')renderVocabGrid();
    else if(page==='expressions')renderExpressionsGrid();
    else if(page==='memory')renderMemoryPage();
}

function saveRecord(){
    const conv=document.getElementById('conversationInput').value.trim();
    const words=wordCardsData.filter(w=>w.word).map(w=>({
        word:w.word,
        phonetic:w.phonetic,
        meaning:w.meaning,
        meaningEn:w.meaningEn||'',
        example:w.example,
        exampleZh:w.exampleZh
    }));
    const expr=[];
    document.querySelectorAll('#expressionsList .vocab-item').forEach(item=>{
        const en=item.querySelector('.en').value.trim(),zh=item.querySelector('.zh').value.trim();
        if(en)expr.push({en,zh});
    });
    if(!conv&&words.length===0&&expr.length===0){showToast('è¯·å¡«å†™å†…å®¹');return}
    const records=getAllRecords();
    records[selectedDate]={conversation:conv,words,expressions:expr,updatedAt:new Date().toISOString()};
    saveAllRecords(records);
    syncVocabulary();
    syncExpressions();
    updateStats();
    renderCalendar();
    showHistoryPreview();
    showToast('ä¿å­˜æˆåŠŸ');
}

function syncVocabulary(){
    const records=getAllRecords(),vocab=getVocabulary();
    Object.keys(records).forEach(date=>{
        const r=records[date];
        if(r.words){r.words.forEach(w=>{
            const k=(w.word||'').toLowerCase();
            if(w.word&&!vocab[k]){
                vocab[k]={
                    word:w.word,
                    phonetic:w.phonetic||'',
                    meaning:w.meaning||'',
                    meaningEn:w.meaningEn||'',
                    example:w.example||'',
                    exampleZh:w.exampleZh||'',
                    addedDate:date,
                    mastery:'new',
                    reviewCount:0,
                    lastReview:null,
                    nextReview:date
                };
            }else if(w.word&&vocab[k]){
                if(w.phonetic&&!vocab[k].phonetic)vocab[k].phonetic=w.phonetic;
                if(w.meaning&&!vocab[k].meaning)vocab[k].meaning=w.meaning;
                if(w.meaningEn&&!vocab[k].meaningEn)vocab[k].meaningEn=w.meaningEn;
                if(w.example&&!vocab[k].example)vocab[k].example=w.example;
                if(w.exampleZh&&!vocab[k].exampleZh)vocab[k].exampleZh=w.exampleZh;
            }
        })}
    });
    saveVocabulary(vocab);updateVocabCount();
}

function syncExpressions(){
    const records=getAllRecords(),expr=getExpressions();
    Object.keys(records).forEach(date=>{
        const r=records[date];
        if(r.expressions){r.expressions.forEach(e=>{
            const k=e.en.toLowerCase().substring(0,50);
            if(e.en&&!expr[k]){expr[k]={en:e.en,zh:e.zh,addedDate:date}}
        })}
    });
    saveExpressions(expr);updateExprCount();
}

function clearForm(){
    document.getElementById('conversationInput').value='';
    wordCardsData=[];
    renderWordCards();
    document.getElementById('expressionsList').innerHTML='<div class="vocab-item"><div class="sentence-input-group"><input type="text" class="en" placeholder="English expression"><input type="text" class="zh" placeholder="ä¸­æ–‡ç¿»è¯‘"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button></div>';
}

function loadRecord(date){
    const r=getRecord(date);
    clearForm();
    if(r){
        document.getElementById('conversationInput').value=r.conversation||'';
        if(r.words&&r.words.length>0){
            wordCardsData=r.words.map((w,i)=>({
                id:Date.now()+i,
                word:w.word||'',
                phonetic:w.phonetic||'',
                meaning:w.meaning||'',
                meaningEn:w.meaningEn||'',
                example:w.example||'',
                exampleZh:w.exampleZh||'',
                loading:false
            }));
            renderWordCards();
        }
        if(r.expressions&&r.expressions.length>0){
            document.getElementById('expressionsList').innerHTML=r.expressions.map(e=>`<div class="vocab-item"><div class="sentence-input-group"><input type="text" class="en" value="${escapeHtml(e.en)}"><input type="text" class="zh" value="${escapeHtml(e.zh)}"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button></div>`).join('');
        }
    }
    showHistoryPreview();
}

function escapeHtml(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML}
function addExpression(){const l=document.getElementById('expressionsList'),i=document.createElement('div');i.className='vocab-item';i.innerHTML='<div class="sentence-input-group"><input type="text" class="en" placeholder="English expression"><input type="text" class="zh" placeholder="ä¸­æ–‡ç¿»è¯‘"></div><button class="delete-btn" onclick="deleteExpression(this)">Ã—</button>';l.appendChild(i);i.querySelector('.en').focus()}
function deleteExpression(btn){const l=document.getElementById('expressionsList');if(l.children.length>1)btn.parentElement.remove();else btn.parentElement.querySelectorAll('input').forEach(i=>i.value='')}

function renderCalendar(){
    const records=getAllRecords();
    const fd=new Date(currentYear,currentMonth,1),ld=new Date(currentYear,currentMonth+1,0);
    const sd=fd.getDay(),dm=ld.getDate();
    document.getElementById('calendarTitle').textContent=`${currentYear}å¹´${currentMonth+1}æœˆ`;
    
    // âœ… ä¿®å¤ï¼šä½¿ç”¨ getLocalDateString è·å–ä»Šå¤©
    const today = getLocalDateString();
    
    let h='';
    const pld=new Date(currentYear,currentMonth,0).getDate();
    for(let i=sd-1;i>=0;i--){
        const d=pld-i;
        const pm=currentMonth===0?11:currentMonth-1;
        const py=currentMonth===0?currentYear-1:currentYear;
        const ds=`${py}-${String(pm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hr=records[ds]?'has-record':'';
        h+=`<div class="day other-month ${hr}" data-date="${ds}">${d}</div>`;
    }
    for(let d=1;d<=dm;d++){
        const ds=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const it=ds===today?'today':'';
        const is=ds===selectedDate?'selected':'';
        const hr=records[ds]?'has-record':'';
        h+=`<div class="day ${it} ${is} ${hr}" data-date="${ds}">${d}</div>`;
    }
    const rd=42-(sd+dm);
    for(let d=1;d<=rd;d++){
        const nm=currentMonth===11?0:currentMonth+1;
        const ny=currentMonth===11?currentYear+1:currentYear;
        const ds=`${ny}-${String(nm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hr=records[ds]?'has-record':'';
        h+=`<div class="day other-month ${hr}" data-date="${ds}">${d}</div>`;
    }
    document.getElementById('calendarDays').innerHTML=h;
    document.querySelectorAll('.day:not(.empty)').forEach(de=>de.addEventListener('click',()=>selectDate(de.dataset.date)));
}

// âœ… ä¿®å¤ï¼šæ‰‹åŠ¨è§£æå­—ç¬¦ä¸²ï¼Œé¿å… Date(string) å¸¦æ¥çš„æ—¶åŒºåç§»
function selectDate(d){
    selectedDate = d;
    const parts = d.split('-');
    if(parts.length === 3) {
        currentYear = parseInt(parts[0]);
        currentMonth = parseInt(parts[1]) - 1;
    }
    renderCalendar();
    loadRecord(d);
}

function prevMonth(){currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--}renderCalendar()}
function nextMonth(){currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++}renderCalendar()}

function updateStats(){
    const records=getAllRecords(),vocab=getVocabulary(),expr=getExpressions();
    const dates=Object.keys(records).sort();
    document.getElementById('totalDays').textContent=dates.length;
    document.getElementById('totalWords').textContent=Object.keys(vocab).length;
    document.getElementById('totalExpressions').textContent=Object.keys(expr).length;
    const mc=Object.values(vocab).filter(v=>v.mastery==='mastered').length;
    document.getElementById('masteredWords').textContent=mc;
    let streak=0;const today=new Date();today.setHours(0,0,0,0);
    for(let i=0;i<=365;i++){const cd=new Date(today);cd.setDate(cd.getDate()-i);
        const ds=getLocalDateString(cd); // âœ… ä¿®å¤ï¼šç»Ÿè®¡æ‰“å¡ä½¿ç”¨æœ¬åœ°æ—¶é—´
        if(records[ds])streak++;else if(i>0)break
    }
    document.getElementById('streakDays').textContent=streak;
}
function updateVocabCount(){document.getElementById('vocabCount').textContent=Object.keys(getVocabulary()).length}
function updateExprCount(){document.getElementById('exprCount').textContent=Object.keys(getExpressions()).length}

function showHistoryPreview(){
    const r=getRecord(selectedDate);const c=document.getElementById('historyPreview');
    if(!r){c.innerHTML='<div class="empty-state" style="padding:24px;text-align:center;color:var(--text-muted)"><p>ğŸ“ è¿™å¤©è¿˜æ²¡æœ‰è®°å½•</p></div>';return}
    // âœ… ä¿®å¤ï¼šç®€å•å­—ç¬¦ä¸²åˆ†å‰²ï¼Œé¿å… new Date åå·®
    const parts = selectedDate.split('-');
    const ds = `${parts[0]}å¹´${parseInt(parts[1])}æœˆ${parseInt(parts[2])}æ—¥`;
    
    let h=`<div class="record-card" style="margin-top:24px"><h3><span>ğŸ“‹</span> ${ds}</h3>`;
    if(r.words&&r.words.length>0){
        h+='<div style="display:flex;flex-direction:column;gap:16px;margin-bottom:24px">';
        r.words.forEach(w=>{
            const meaningEn = w.meaningEn || '';
            h+=`<div class="word-card" style="cursor:pointer" onclick="speak('${escapeHtml(w.word).replace(/'/g,"\\'")}')">
                <div class="word-card-header"><div class="word-card-main"><span class="word-card-word">${escapeHtml(w.word)}</span><span class="word-card-phonetic">${escapeHtml(w.phonetic||'')}</span></div></div>
                ${w.meaning?`<div class="word-card-meaning">${escapeHtml(w.meaning)}${meaningEn?`<div class="word-card-meaning-en">EN: ${escapeHtml(meaningEn)}</div>`:''}</div>`:''}
                ${w.example?`<div class="word-card-example" onclick="event.stopPropagation();speakElement(this,'${escapeHtml(w.example).replace(/'/g,"\\'")}')"><div class="en"><span class="speak-icon">ğŸ”Š</span> ${escapeHtml(w.example)}</div>${w.exampleZh?`<div class="zh">${escapeHtml(w.exampleZh)}</div>`:''}</div>`:''}
            </div>`;
        });
        h+='</div>';
    }
    if(r.expressions&&r.expressions.length>0){
        h+='<div class="expression-list">';
        r.expressions.forEach(e=>{h+=`<div class="expression-item" onclick="speakElement(this,'${escapeHtml(e.en).replace(/'/g,"\\'")}')"><div class="en">ğŸ”Š ${escapeHtml(e.en)}</div><div class="zh">${escapeHtml(e.zh)}</div></div>`});
        h+='</div>';
    }
    h+='</div>';c.innerHTML=h;
}

function renderVocabGrid(){
    const vocab=getVocabulary();const search=document.getElementById('vocabSearch').value.toLowerCase();const mf=document.getElementById('masteryFilter').value;
    let items=Object.values(vocab);
    if(search)items=items.filter(v=>(v.word||'').toLowerCase().includes(search)||(v.meaning||'').toLowerCase().includes(search)||(v.meaningEn||'').toLowerCase().includes(search));
    if(mf!=='all')items=items.filter(v=>v.mastery===mf);
    items.sort((a,b)=>new Date(b.addedDate)-new Date(a.addedDate));
    const tp=Math.ceil(items.length/PER_PAGE);const si=(currentVocabPage-1)*PER_PAGE;const pi=items.slice(si,si+PER_PAGE);
    const g=document.getElementById('vocabGrid');

    if(items.length===0){
        g.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:40px">ğŸ“š è¿˜æ²¡æœ‰ç”Ÿè¯</div>';
    }else{
        g.innerHTML=pi.map(v=>`
            <div class="vocab-grid-card" onclick="speakElement(this,'${escapeHtml(v.word).replace(/'/g,"\\'")}')">
                <div class="vocab-grid-header">
                    <div><span class="vocab-grid-word">${escapeHtml(v.word)}</span><span class="vocab-grid-phonetic">${escapeHtml(v.phonetic||'')}</span></div>
                    <div class="vocab-grid-meta">
                        ${getMasteryBadge(v.mastery)}
                        <button class="action-btn" onclick="event.stopPropagation();deleteVocab('${v.word.toLowerCase()}')" style="margin-left:8px;background:transparent;border:none;cursor:pointer;opacity:0.4;font-size:1.1rem">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="vocab-grid-meaning">${escapeHtml(v.meaning||'æš‚æ— ä¸­æ–‡é‡Šä¹‰')}</div>
                ${v.meaningEn?`<div class="vocab-grid-meaning-en">EN: ${escapeHtml(v.meaningEn)}</div>`:''}
                ${v.example?`<div class="vocab-grid-example" onclick="event.stopPropagation();speakElement(this,'${escapeHtml(v.example).replace(/'/g,"\\'")}')">
                    <div class="en">ğŸ”Š ${escapeHtml(v.example)}</div>
                    ${v.exampleZh?`<div class="zh">${escapeHtml(v.exampleZh)}</div>`:''}
                </div>`:''}
                <div class="vocab-grid-footer"><span>${v.addedDate}</span><span style="color:var(--accent-blue)">ğŸ”Š ç‚¹å‡»æœ—è¯»</span></div>
            </div>
        `).join('');
    }
    renderPagination('vocabPagination',tp,currentVocabPage,p=>{currentVocabPage=p;renderVocabGrid()});
}

function getMasteryBadge(m){
    const b={
        new:'<span class="mastery-badge new">ğŸ†• æ–°</span>',
        learning:'<span class="mastery-badge learning">ğŸ“– å­¦ä¹ </span>',
        familiar:'<span class="mastery-badge familiar">ğŸ’¡ ç†Ÿæ‚‰</span>',
        mastered:'<span class="mastery-badge mastered">âœ… æŒæ¡</span>'
    };
    return b[m]||b.new;
}
function renderPagination(cid,tp,cp,opc){
    const c=document.getElementById(cid);
    if(tp<=1){c.innerHTML='';return}
    c.innerHTML=`<button ${cp===1?'disabled':''}>ä¸Šä¸€é¡µ</button><span class="page-info" style="margin:0 12px;color:var(--text-muted);font-size:0.9rem">${cp} / ${tp}</span><button ${cp===tp?'disabled':''}>ä¸‹ä¸€é¡µ</button>`;
    c.querySelector('button:first-child').onclick=()=>{if(cp>1)opc(cp-1)};
    c.querySelector('button:last-child').onclick=()=>{if(cp<tp)opc(cp+1)};
}
function filterVocab(){currentVocabPage=1;renderVocabGrid()}
function deleteVocab(k){if(confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªç”Ÿè¯å—ï¼Ÿ')){const v=getVocabulary();delete v[k];saveVocabulary(v);renderVocabGrid();updateVocabCount();updateStats();showToast('å·²åˆ é™¤')}}

function renderExpressionsGrid(){
    const expr=getExpressions();const search=document.getElementById('exprSearch').value.toLowerCase();
    let items=Object.values(expr);
    if(search)items=items.filter(e=>e.en.toLowerCase().includes(search)||e.zh.toLowerCase().includes(search));
    items.sort((a,b)=>new Date(b.addedDate)-new Date(a.addedDate));
    const tp=Math.ceil(items.length/12);const si=(currentExprPage-1)*12;const pi=items.slice(si,si+12);
    const g=document.getElementById('expressionGrid');
    if(items.length===0){g.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:40px">ğŸ’¬ è¿˜æ²¡æœ‰ä»Šæ—¥è¡¨è¾¾</div>'}
    else{g.innerHTML=pi.map(e=>`<div class="expression-item" style="height:100%" onclick="speakElement(this,'${escapeHtml(e.en).replace(/'/g,"\\'")}')"><div class="en">${escapeHtml(e.en)}</div><div class="zh">${escapeHtml(e.zh)}</div><div class="meta" style="margin-top:12px;font-size:0.75rem;color:var(--text-muted);display:flex;justify-content:space-between"><span>${e.addedDate}</span><span>ğŸ”Š æœ—è¯»</span></div></div>`).join('')}
    renderPagination('exprPagination',tp,currentExprPage,p=>{currentExprPage=p;renderExpressionsGrid()});
}
function filterExpressions(){currentExprPage=1;renderExpressionsGrid()}

function renderMemoryPage(){
    const vocab=getVocabulary();const items=Object.values(vocab);
    const counts={
        new:items.filter(v=>v.mastery==='new').length,
        learning:items.filter(v=>v.mastery==='learning').length,
        familiar:items.filter(v=>v.mastery==='familiar').length,
        mastered:items.filter(v=>v.mastery==='mastered').length
    };
    document.getElementById('memNewCount').textContent=counts.new;
    document.getElementById('memLearningCount').textContent=counts.learning;
    document.getElementById('memFamiliarCount').textContent=counts.familiar;
    document.getElementById('memMasteredCount').textContent=counts.mastered;
    
    // âœ… ä¿®å¤ï¼šå¤ä¹ è®¡åˆ’ä½¿ç”¨æœ¬åœ°æ—¶é—´
    const today = getLocalDateString();
    
    const dfr=items.filter(v=>v.nextReview<=today&&v.mastery!=='mastered');
    const nw=items.filter(v=>v.mastery==='new');
    const c=document.getElementById('memoryContent');
    if(reviewQueue.length>0){renderFlashcard()}
    else{
        c.innerHTML=`<div class="start-review"><h2>ğŸ§  å¼€å§‹è®°å¿†</h2><p style="color:var(--text-secondary)">é€‰æ‹©ä¸€ä¸ªæ¨¡å¼å¼€å§‹å¤ä¹ </p><div class="review-options">
            <div class="review-option" onclick="startReview('due')"><div class="num" style="color:var(--accent-orange)">${dfr.length}</div><div class="label">å¾…å¤ä¹ </div></div>
            <div class="review-option" onclick="startReview('new')"><div class="num" style="color:var(--accent-blue)">${nw.length}</div><div class="label">æ–°è¯</div></div>
            <div class="review-option" onclick="startReview('all')"><div class="num" style="color:var(--text-primary)">${items.length}</div><div class="label">å…¨éƒ¨</div></div>
            <div class="review-option" onclick="startReview('random20')"><div class="num" style="color:var(--accent-purple)">20</div><div class="label">éšæœº</div></div>
        </div></div>`;
    }
}

function startReview(mode){
    const vocab=getVocabulary();const items=Object.values(vocab);
    // âœ… ä¿®å¤ï¼šå¤ä¹ å¼€å§‹ä½¿ç”¨æœ¬åœ°æ—¶é—´
    const today = getLocalDateString();
    
    switch(mode){
        case'due':reviewQueue=items.filter(v=>v.nextReview<=today&&v.mastery!=='mastered');break;
        case'new':reviewQueue=items.filter(v=>v.mastery==='new');break;
        case'all':reviewQueue=[...items];break;
        case'random20':reviewQueue=shuffleArray([...items]).slice(0,20);break
    }
    if(reviewQueue.length===0){showToast('æ²¡æœ‰å¯å¤ä¹ çš„å•è¯');return}
    reviewQueue=shuffleArray(reviewQueue);currentCardIndex=0;reviewStats={again:0,hard:0,good:0,easy:0};isCardFlipped=false;renderFlashcard();
}
function shuffleArray(a){const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}

function renderFlashcard(){
    const c=document.getElementById('memoryContent');
    if(currentCardIndex>=reviewQueue.length){
        c.innerHTML=`<div class="start-review"><div style="font-size:3rem;margin-bottom:16px">ğŸ‰</div><h2>å¤ä¹ å®Œæˆï¼</h2><p style="color:var(--text-secondary)">æœ¬æ¬¡å¤ä¹ ç»Ÿè®¡</p>
        <div class="memory-stats" style="margin-top:24px">
            <div class="memory-stat"><div class="num" style="color:var(--accent-red)">${reviewStats.again}</div><div class="label">å¿˜è®°</div></div>
            <div class="memory-stat"><div class="num" style="color:var(--accent-orange)">${reviewStats.hard}</div><div class="label">å›°éš¾</div></div>
            <div class="memory-stat"><div class="num" style="color:var(--accent-blue)">${reviewStats.good}</div><div class="label">è®°ä½</div></div>
            <div class="memory-stat"><div class="num" style="color:var(--accent-green)">${reviewStats.easy}</div><div class="label">ç®€å•</div></div>
        </div>
        <button class="btn btn-primary" style="margin:20px auto" onclick="resetReview()">è¿”å›</button></div>`;
        return;
    }
    const card=reviewQueue[currentCardIndex];
    c.innerHTML=`<div class="flashcard-container"><div class="flashcard ${isCardFlipped?'flipped':''}" onclick="flipCard()">
        <div style="position:absolute;top:20px;right:24px;color:var(--text-muted);font-size:0.9rem">${currentCardIndex+1} / ${reviewQueue.length}</div>
        <div style="position:absolute;top:20px;left:24px">${getMasteryBadge(card.mastery)}</div>
        <div class="flashcard-front">
            <div class="flashcard-word" onclick="event.stopPropagation();speak('${escapeHtml(card.word).replace(/'/g,"\\'")}')">${escapeHtml(card.word)}</div>
            <div class="flashcard-phonetic">${escapeHtml(card.phonetic||'')}</div>
            <div class="flashcard-hint">ç‚¹å‡»å¡ç‰‡ç¿»è½¬æŸ¥çœ‹é‡Šä¹‰</div>
        </div>
        <div class="flashcard-back">
            <div class="flashcard-meaning">${escapeHtml(card.meaning||'æš‚æ— ä¸­æ–‡é‡Šä¹‰')}</div>
            ${card.meaningEn?`<div style="font-size:0.9rem;color:var(--text-muted);text-align:center;margin-bottom:12px;line-height:1.5">EN: ${escapeHtml(card.meaningEn)}</div>`:''}
            ${card.example?`<div class="flashcard-example"><div class="en" style="font-family:'Crimson Pro',serif;font-size:1.1rem;margin-bottom:4px">${escapeHtml(card.example)}</div>${card.exampleZh?`<div class="zh" style="font-size:0.9rem;color:var(--text-secondary)">${escapeHtml(card.exampleZh)}</div>`:''}</div>`:''}
        </div>
        <button style="position:absolute;bottom:20px;right:24px;background:var(--bg-input);border:none;padding:8px 16px;border-radius:20px;cursor:pointer;color:var(--text-secondary);font-size:0.85rem" onclick="event.stopPropagation();speak('${escapeHtml(card.word).replace(/'/g,"\\'")}')">ğŸ”Š æœ—è¯»</button>
    </div></div>
    <div class="memory-buttons" style="display:${isCardFlipped?'grid':'none'}">
        <button class="memory-btn again" onclick="rateCard('again')"><span style="font-weight:600">å¿˜è®°äº†</span><span style="font-size:0.75rem;opacity:0.8">1åˆ†é’Ÿ</span></button>
        <button class="memory-btn hard" onclick="rateCard('hard')"><span style="font-weight:600">æœ‰ç‚¹éš¾</span><span style="font-size:0.75rem;opacity:0.8">10åˆ†é’Ÿ</span></button>
        <button class="memory-btn good" onclick="rateCard('good')"><span style="font-weight:600">è®°ä½äº†</span><span style="font-size:0.75rem;opacity:0.8">1å¤©</span></button>
        <button class="memory-btn easy" onclick="rateCard('easy')"><span style="font-weight:600">å¤ªç®€å•</span><span style="font-size:0.75rem;opacity:0.8">4å¤©</span></button>
    </div>`;
}
function flipCard(){isCardFlipped=!isCardFlipped;renderFlashcard()}
function rateCard(rating){
    const card=reviewQueue[currentCardIndex];const vocab=getVocabulary();const k=card.word.toLowerCase();
    if(vocab[k]){
        vocab[k].reviewCount++;
        // âœ… ä¿®å¤ï¼šä½¿ç”¨æœ¬åœ°æ—¶é—´è®°å½•æœ€åå¤ä¹ æ—¶é—´
        vocab[k].lastReview = getLocalDateString();
        
        const today=new Date();let nr=new Date(today);
        switch(rating){
            case'again':vocab[k].mastery='learning';nr.setMinutes(nr.getMinutes()+1);break;
            case'hard':vocab[k].mastery='learning';nr.setMinutes(nr.getMinutes()+10);break;
            case'good':
                if(vocab[k].mastery==='new')vocab[k].mastery='learning';
                else if(vocab[k].mastery==='learning')vocab[k].mastery='familiar';
                nr.setDate(nr.getDate()+1);break;
            case'easy':
                if(vocab[k].mastery==='new'||vocab[k].mastery==='learning')vocab[k].mastery='familiar';
                else if(vocab[k].mastery==='familiar')vocab[k].mastery='mastered';
                nr.setDate(nr.getDate()+4);break
        }
        // âœ… ä¿®å¤ï¼šä½¿ç”¨æœ¬åœ°æ—¶é—´è®°å½•ä¸‹æ¬¡å¤ä¹ æ—¶é—´
        vocab[k].nextReview = getLocalDateString(nr);
        
        saveVocabulary(vocab);
    }
    reviewStats[rating]++;currentCardIndex++;isCardFlipped=false;renderFlashcard();renderMemoryPage();
}
function resetReview(){reviewQueue=[];currentCardIndex=0;renderMemoryPage()}
function showToast(msg){const t=document.getElementById('toast');document.getElementById('toastMessage').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

document.addEventListener('DOMContentLoaded',()=>{
    syncVocabulary();syncExpressions();renderCalendar();updateStats();updateVocabCount();updateExprCount();loadRecord(selectedDate);renderWordCards();
});
document.addEventListener('keydown',e=>{
    if(reviewQueue.length>0&&isCardFlipped){
        switch(e.key){case'1':rateCard('again');break;case'2':rateCard('hard');break;case'3':rateCard('good');break;case'4':rateCard('easy');break}
    } else if(reviewQueue.length>0&&e.code==='Space'){e.preventDefault();flipCard()}
});
</script>
</body>
</html>
